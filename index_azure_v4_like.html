<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SCIVIC ECIM — Azure</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei","PingFang SC",Roboto,Helvetica,Arial,sans-serif}
    .btn{ padding:0.5rem 0.75rem; border-radius:0.5rem; background:#0f172a; color:#fff }
    .btn:hover{ background:#334155 }
    .btn:disabled{ opacity:.5 }
    .btn-sec{ padding:0.5rem 0.75rem; border-radius:0.5rem; background:#f1f5f9; color:#334155 }
    .btn-sec:hover{ background:#e2e8f0 }
    .input{ width:100%; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem }
    .input:focus{ outline:none; box-shadow:0 0 0 2px #94a3b8 }
    .card{ background:#fff; border-radius:1rem; box-shadow:0 10px 20px rgb(0 0 0 / .05); padding:1.25rem }
    .tab{ padding:0.5rem 1rem; border-radius:9999px; cursor:pointer }
    .tab.active{ background:#0f172a; color:#fff }
    table{table-layout:fixed; width:100%}
    th,td{ padding:0.5rem; border-bottom:1px solid #f1f5f9; vertical-align:top }
    th{ text-align:left; color:#64748b; font-size:0.875rem }
    td{ font-size:0.875rem }
    .w-model{min-width:80px; max-width:100px; word-break:break-word}
    .w-type{min-width:80px; max-width:120px}
    .w-time{min-width:140px; max-width:200px; word-break:break-word}
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">SCIVIC ECIM</h1>
      <div class="flex items-center gap-2">
        <button id="lang-btn" class="btn-sec">中文 / EN</button>
        <span id="login-user" class="text-sm text-gray-500"></span>
      </div>
    </div>

    <div class="flex gap-2 mb-4">
      <button data-tab="overview"  class="tab active">库存总览</button>
      <button data-tab="inbound"   class="tab">入库</button>
      <button data-tab="outbound"  class="tab">出库</button>
      <button data-tab="transfer"  class="tab">移库</button>
      <button data-tab="logs"      class="tab">操作日志</button>
    </div>

    <section id="panel-overview" class="card">
      <div class="flex items-center gap-3 mb-3">
        <input id="ov-search" class="input" placeholder="搜索：型号 / 名称 / 库位 / 备注"/>
        <button id="ov-refresh" class="btn-sec">刷新</button>
        <button id="ov-export" class="btn-sec">导出 CSV</button>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th class="w-model">型号</th>
              <th>名称</th>
              <th>单位</th>
              <th>数量</th>
              <th>库位</th>
              <th>使用位置</th>
              <th>材质</th>
              <th>备注</th>
              <th class="w-time">更新时间</th>
            </tr>
          </thead>
          <tbody id="ov-tbody"></tbody>
        </table>
      </div>
    </section>

    <section id="panel-inbound" class="card hidden">
      <h2 class="font-semibold mb-3">入库</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <div><label class="text-sm">型号 *</label><input id="in-model" class="input"/></div>
        <div><label class="text-sm">名称</label><input id="in-name" class="input"/></div>
        <div><label class="text-sm">数量 *</label><input id="in-qty" type="number" class="input"/></div>
        <div><label class="text-sm">单位</label><input id="in-unit" class="input" value="PCS"/></div>
        <div><label class="text-sm">库位 *</label><input id="in-storage" class="input"/></div>
        <div><label class="text-sm">使用位置</label><input id="in-location" class="input"/></div>
        <div><label class="text-sm">材质</label><input id="in-material" class="input"/></div>
        <div><label class="text-sm">领用人</label><input id="in-recipient" class="input"/></div>
        <div class="md:col-span-3"><label class="text-sm">备注</label><input id="in-comments" class="input"/></div>
      </div>
      <div class="mt-4">
        <button id="btn-inbound" class="btn">提交入库</button>
      </div>
    </section>

    <section id="panel-outbound" class="card hidden">
      <h2 class="font-semibold mb-3">出库</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <div><label class="text-sm">型号 *</label><input id="out-model" class="input"/></div>
        <div><label class="text-sm">名称</label><input id="out-name" class="input"/></div>
        <div><label class="text-sm">数量 *</label><input id="out-qty" type="number" class="input"/></div>
        <div><label class="text-sm">单位</label><input id="out-unit" class="input" value="PCS"/></div>
        <div><label class="text-sm">库位 *</label><input id="out-storage" class="input"/></div>
        <div><label class="text-sm">使用位置</label><input id="out-location" class="input"/></div>
        <div><label class="text-sm">材质</label><input id="out-material" class="input"/></div>
        <div><label class="text-sm">领用人</label><input id="out-recipient" class="input"/></div>
        <div class="md:col-span-3"><label class="text-sm">备注</label><input id="out-comments" class="input"/></div>
      </div>
      <div class="mt-4">
        <button id="btn-outbound" class="btn">提交出库</button>
      </div>
    </section>

    <section id="panel-transfer" class="card hidden">
      <h2 class="font-semibold mb-3">移库</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <div><label class="text-sm">型号 *</label><input id="tf-model" class="input"/></div>
        <div><label class="text-sm">名称</label><input id="tf-name" class="input"/></div>
        <div><label class="text-sm">数量 *</label><input id="tf-qty" type="number" class="input"/></div>
        <div><label class="text-sm">单位</label><input id="tf-unit" class="input" value="PCS"/></div>
        <div><label class="text-sm">来源库位 *</label><input id="tf-from" class="input"/></div>
        <div><label class="text-sm">目标库位 *</label><input id="tf-to" class="input"/></div>
        <div class="md:col-span-3"><label class="text-sm">备注</label><input id="tf-comments" class="input"/></div>
      </div>
      <div class="mt-4">
        <button id="btn-transfer" class="btn">提交移库</button>
      </div>
    </section>

    <section id="panel-logs" class="card hidden">
      <div class="flex items-center gap-3 mb-3">
        <input id="logs-search" class="input" placeholder="搜索：型号 / 名称 / 库位 / 操作人 / 备注"/>
        <button id="logs-refresh" class="btn-sec">刷新</button>
        <button id="logs-export" class="btn-sec">导出 CSV（当前筛选）</button>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th class="w-time">时间</th>
              <th class="w-type">类型</th>
              <th class="w-model">型号</th>
              <th>名称</th>
              <th>单位</th>
              <th>数量</th>
              <th>库位</th>
              <th>From</th>
              <th>To</th>
              <th>领用人</th>
              <th>操作人</th>
              <th>备注</th>
            </tr>
          </thead>
          <tbody id="logs-tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="login-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center">
    <div class="card w-[92%] max-w-lg">
      <h3 class="text-lg font-semibold mb-3" id="login-title">登录</h3>
      <div class="grid gap-3">
        <div>
          <label class="text-sm">邮箱 *</label>
          <input id="login-email" class="input" placeholder="you@example.com"/>
        </div>
        <div class="flex items-end gap-2">
          <div class="flex-1">
            <label class="text-sm">验证码 *</label>
            <input id="login-otp" class="input" placeholder="6位验证码"/>
          </div>
          <button id="btn-send-otp" class="btn-sec whitespace-nowrap">发送验证码</button>
        </div>
      </div>
      <div class="mt-4 flex items-center gap-2">
        <button id="btn-login" class="btn">登录</button>
        <span id="login-tip" class="text-sm text-gray-500"></span>
      </div>
      <p class="text-xs text-gray-400 mt-3">提示：目前验证码由后端 <code>/api/send_otp</code> 负责发送；若未部署此函数，发送按钮会提示占位信息，但仍需输入任意 6 位验证码并通过白名单验证。</p>
    </div>
  </div>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-slate-900 text-white"></div>

<script>
(() => {
  const API_BASE = "https://meston-inventory-api-dsf5btcbb2dpajc2.centralus-01.azurewebsites.net";
  let LANG = "zh";
  let SESSION = { email: "", otpOk:false };

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el.classList.remove('hidden');
  const hide = (el)=>el.classList.add('hidden');
  const norm = (s)=> (s||"").toString().toLowerCase();

  function notify(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.remove("hidden");
    setTimeout(()=>el.classList.add("hidden"), 1800);
  }

  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.getAttribute("data-tab");
      ["overview","inbound","outbound","transfer","logs"].forEach(k=>{
        const p = $("panel-"+k);
        if(k===target) show(p); else hide(p);
      });
      if(target==="overview") refreshOverview();
      if(target==="logs") refreshLogs();
    });
  });

  $("lang-btn").addEventListener("click", ()=>{
    LANG = (LANG==="zh")?"en":"zh";
    applyLang();
  });
  function applyLang(){
    const map = {
      zh:{inv:"库存总览",inb:"入库",out:"出库",tf:"移库",lg:"操作日志",searchOv:"搜索：型号 / 名称 / 库位 / 备注",searchLg:"搜索：型号 / 名称 / 库位 / 操作人 / 备注",refresh:"刷新",export:"导出 CSV",inbound:"提交入库",outbound:"提交出库",transfer:"提交移库",login:"登录",sendOtp:"发送验证码",loginTitle:"登录"},
      en:{inv:"Overview",inb:"Inbound",out:"Outbound",tf:"Transfer",lg:"Logs",searchOv:"Search: model / name / storage / comments",searchLg:"Search: model / name / storage / operator / comments",refresh:"Refresh",export:"Export CSV",inbound:"Submit Inbound",outbound:"Submit Outbound",transfer:"Submit Transfer",login:"Sign in",sendOtp:"Send OTP",loginTitle:"Sign in"}
    }[LANG];
    document.querySelector('[data-tab="overview"]').textContent = map.inv;
    document.querySelector('[data-tab="inbound"]').textContent  = map.inb;
    document.querySelector('[data-tab="outbound"]').textContent = map.out;
    document.querySelector('[data-tab="transfer"]').textContent = map.tf;
    document.querySelector('[data-tab="logs"]').textContent     = map.lg;
    $("ov-search").placeholder = map.searchOv;
    $("ov-refresh").textContent = map.refresh;
    $("ov-export").textContent = map.export;
    $("logs-search").placeholder = map.searchLg;
    $("logs-refresh").textContent = map.refresh;
    $("logs-export").textContent = map.export;
    $("btn-inbound").textContent = map.inbound;
    $("btn-outbound").textContent = map.outbound;
    $("btn-transfer").textContent = map.transfer;
    $("btn-login").textContent = map.login;
    $("btn-send-otp").textContent = map.sendOtp;
    $("login-title").textContent = map.loginTitle;
  }
  applyLang();

  // OTP
  $("btn-send-otp").addEventListener("click", async ()=>{
    const email = $("login-email").value.trim();
    if(!email){ notify(LANG==='zh'?'请输入邮箱':'Please input email'); return; }
    try{
      const res = await fetch(API_BASE + "/api/send_otp", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ email })
      });
      if(!res.ok){
        notify(LANG==='zh'?'已发送请求；若后端未部署 send_otp，请联系管理员':'Request sent; if send_otp not deployed, contact admin');
      }else{
        notify(LANG==='zh'?'验证码已发送，请检查邮箱':'OTP sent, check your email');
      }
    }catch(e){
      notify(LANG==='zh'?'发送失败（占位），请联系管理员':'Send failed (placeholder), contact admin');
    }
  });

  $("btn-login").addEventListener("click", async ()=>{
    const email = $("login-email").value.trim();
    const otp = $("login-otp").value.trim();
    if(!email){ notify(LANG==='zh'?'请输入邮箱':'Please input email'); return; }
    if(!otp || otp.length < 4){ notify(LANG==='zh'?'请输入验证码':'Please input OTP'); return; }
    try{
      const res = await fetch(API_BASE + "/api/dict_check?email=" + encodeURIComponent(email));
      const ok = res.ok ? await res.json(): null;
      if(res.ok && ok && ok.allowed===true){
        SESSION.email = email; SESSION.otpOk = true;
        $("login-user").textContent = email;
        hide($("login-modal"));
        refreshOverview();
        notify(LANG==='zh'?'登录成功':'Signed in');
      }else{
        const msg = res.ok ? (ok && ok.reason? ok.reason : '') : await res.text();
        notify((LANG==='zh'?'不在白名单：':'Not whitelisted: ') + (msg||''));
      }
    }catch(err){
      console.error(err);
      notify(LANG==='zh'?'登录失败，请检查网络':'Login failed');
    }
  });

  // Overview
  let overviewAll = [];
  async function refreshOverview(){
    try{
      const res = await fetch(API_BASE + "/api/overview?limit=10000");
      const data = await res.json();
      overviewAll = Array.isArray(data)? data : (data?.data||[]);
      renderOverview();
    }catch(e){ console.error(e); notify(LANG==='zh'?'读取库存失败':'Load overview failed'); }
  }
  function renderOverview(){
    const q = norm($("ov-search").value);
    const rows = overviewAll.filter(r => {
      const line = [r.model,r.name,r.unit,r.storage,r.location,r.material,r.comments].join(" ").toLowerCase();
      return !q || line.includes(q);
    });
    const tb = $("ov-tbody"); tb.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="w-model">${esc(r.model)}</td>
        <td>${esc(r.name||"")}</td>
        <td>${esc(r.unit||"")}</td>
        <td>${r.total??""}</td>
        <td>${esc(r.storage||"")}</td>
        <td>${esc(r.location||"")}</td>
        <td>${esc(r.material||"")}</td>
        <td>${esc(r.comments||"")}</td>
        <td class="w-time">${fmtTime(r.last_updated)}</td>`;
      tb.appendChild(tr);
    }
  }
  $("ov-search").addEventListener("input", renderOverview);
  $("ov-refresh").addEventListener("click", refreshOverview);
  $("ov-export").addEventListener("click", ()=>{
    const q = norm($("ov-search").value);
    const rows = overviewAll.filter(r => {
      const line = [r.model,r.name,r.unit,r.storage,r.location,r.material,r.comments].join(" ").toLowerCase();
      return !q || line.includes(q);
    });
    const csv = Papa.unparse(rows);
    downloadTxt("overview.csv", csv);
  });

  // Logs
  let logsAll = []; let logsFiltered = [];
  async function refreshLogs(){
    try{
      const res = await fetch(API_BASE + "/api/logs?limit=10000");
      const data = await res.json();
      logsAll = Array.isArray(data)? data : (data?.data||[]);
      renderLogs();
    }catch(e){ console.error(e); notify(LANG==='zh'?'读取日志失败':'Load logs failed'); }
  }
  function renderLogs(){
    const q = norm($("logs-search").value);
    logsFiltered = logsAll.filter(r=>{
      const line = [r.type,r.model,r.name,r.unit,r.quantity,r.storage,r.from_storage,r.to_storage,r.recipient,r.operator,r.comments].join(" ").toLowerCase();
      return !q || line.includes(q);
    });
    const tb = $("logs-tbody"); tb.innerHTML = "";
    for(const r of logsFiltered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="w-time">${fmtTime(r.created_at)}</td>
        <td class="w-type">${esc(r.type)}</td>
        <td class="w-model">${esc(r.model||"")}</td>
        <td>${esc(r.name||"")}</td>
        <td>${esc(r.unit||"")}</td>
        <td>${r.quantity??""}</td>
        <td>${esc(r.storage||"")}</td>
        <td>${esc(r.from_storage||"")}</td>
        <td>${esc(r.to_storage||"")}</td>
        <td>${esc(r.recipient||"")}</td>
        <td>${esc(r.operator||"")}</td>
        <td>${esc(r.comments||"")}</td>`;
      tb.appendChild(tr);
    }
  }
  $("logs-search").addEventListener("input", renderLogs);
  $("logs-refresh").addEventListener("click", refreshLogs);
  $("logs-export").addEventListener("click", ()=>{
    const csv = Papa.unparse(logsFiltered);
    downloadTxt("logs_filtered.csv", csv);
  });

  // Ops
  $("btn-inbound").addEventListener("click", ()=>submitTx("inbound", {
    model: v("in-model"), name:v("in-name"), quantity: num("in-qty"),
    unit:v("in-unit")||"PCS", storage:v("in-storage"),
    location:v("in-location"), material:v("in-material"),
    comments:v("in-comments"), recipient:v("in-recipient"),
    operator: SESSION.email || "user"
  }));
  $("btn-outbound").addEventListener("click", ()=>submitTx("outbound", {
    model: v("out-model"), name:v("out-name"), quantity: num("out-qty"),
    unit:v("out-unit")||"PCS", storage:v("out-storage"),
    location:v("out-location"), material:v("out-material"),
    comments:v("out-comments"), recipient:v("out-recipient"),
    operator: SESSION.email || "user"
  }));
  $("btn-transfer").addEventListener("click", ()=>submitTx("transfer", {
    model: v("tf-model"), name:v("tf-name"), quantity: num("tf-qty"),
    unit:v("tf-unit")||"PCS", from_storage:v("tf-from"), to_storage:v("tf-to"),
    comments:v("tf-comments"),
    operator: SESSION.email || "user"
  }));

  async function submitTx(kind, payload){
    try{
      if(!payload.model || !payload.quantity || payload.quantity<=0){
        notify(LANG==='zh'?'请输入必填项（型号、数量）':'Please fill required fields'); return;
      }
      if(kind!=="transfer" && !payload.storage){
        notify(LANG==='zh'?'请输入库位':'Please input storage'); return;
      }
      if(kind==="transfer" && (!payload.from_storage || !payload.to_storage)){
        notify(LANG==='zh'?'请输入来源/目标库位':'Please input from/to storage'); return;
      }
      const res = await fetch(API_BASE + "/api/"+kind, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt||("HTTP "+res.status));
      }
      notify(LANG==='zh'?'操作成功':'Success');
      refreshOverview();
      refreshLogs();
      clearInputs(kind);
    }catch(e){
      console.error(e);
      notify((LANG==='zh'?'失败：':'Failed: ') + e.message);
    }
  }

  // Utils
  function esc(s){ return (s??"").toString().replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])); }
  function v(id){ return $(id).value.trim(); }
  function num(id){ return Number($(id).value); }
  function fmtTime(t){ try{ const d = new Date(t); if(!isNaN(d.getTime())) return d.toLocaleString(); }catch{} return (t||""); }
  function downloadTxt(name, content){
    const blob = new Blob([content], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }
  function clearInputs(kind){
    const ids = {
      inbound:["in-model","in-name","in-qty","in-unit","in-storage","in-location","in-material","in-comments","in-recipient"],
      outbound:["out-model","out-name","out-qty","out-unit","out-storage","out-location","out-material","out-comments","out-recipient"],
      transfer:["tf-model","tf-name","tf-qty","tf-unit","tf-from","tf-to","tf-comments"]
    }[kind] || [];
    ids.forEach(id=>{ const el=$(id); if(el) el.value=""; });
  }

  // Require login
  show($("login-modal"));
})();
</script>
</body>
</html>
