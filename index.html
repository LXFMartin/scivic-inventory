<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SCIVIC ECIM</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    body { font-family: Inter, "Microsoft YaHei", sans-serif; }
    .tab-button.active {
      border-color:#3b82f6;
      color:#3b82f6;
      background:#eff6ff;
    }
    .notification {
      position:fixed;
      top:35%;
      left:50%;
      padding:12px 16px;
      border-radius:10px;
      color:#fff;
      opacity:0;
      transform:translate(-50%,-12px);
      transition:.25s;
      z-index:1000;
      max-width:90vw;
      text-align:center;
      box-shadow:0 10px 20px rgba(0,0,0,.15)
    }
    .notification.show { opacity:1; transform:translate(-50%,0); }
    .notification.success { background:#22c55e; }
    .notification.error { background:#ef4444; }

    .table-container { max-height:60vh; overflow:auto; }

    .icon-btn {
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:6px 10px;
    }
    .disabled { opacity:.5; pointer-events:none; }

    /* è¡¨æ ¼ä¼˜åŒ– */
    th { white-space: nowrap !important; }
    th#th-model,
    th#logs-th-model {
      min-width:90px;
      max-width:110px;
    }

    table { table-layout:auto !important; width:100%; }
    table th,
    table td {
      text-align:left;
      padding:8px 10px;
      word-break:keep-all;
      white-space:nowrap;
    }

    th#th-stock,
    th#logs-th-qty,
    th#th-storage,
    th#logs-th-storage { min-width:100px; }

    /* ç´§ç¼©â€œå‹å·â€åˆ—ï¼ˆé¢„è§ˆ & æ—¥å¿—ï¼‰ */
    th#th-model,
    th#logs-th-model {
      min-width:20px;
      max-width:50px;
    }

    table th:not(#th-model):not(#logs-th-model),
    table td {
      white-space:nowrap;
      word-break:keep-all;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-900">

<!-- å…¨å±€å¼¹å‡ºæç¤º -->
<div id="notification" class="notification"></div>

<div class="container mx-auto p-4 md:p-8">
  <!-- é¡¶éƒ¨æ ‡é¢˜ -->
  <header class="text-center mb-4">
    <h1 class="text-3xl md:text-4xl font-bold" id="app-title">SCIVIC ECIM - åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
    <p class="text-gray-500" id="app-subtitle">Inventory Management System</p>
  </header>

  <!-- ç™»å½•å¡ç‰‡ -->
  <div id="login-card" class="max-w-xl mx-auto bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-lg font-semibold mb-2" id="login-title">ç™»å½• (Email + éªŒè¯ç )</h3>
    <p class="text-sm text-gray-500 mb-4" id="login-desc">
      è¾“å…¥é‚®ç®±è·å–éªŒè¯ç ï¼ŒéªŒè¯æˆåŠŸåç™»å½•ã€‚ä»…ç™½åå•é‚®ç®±å¯è¿›è¡Œå…¥/å‡ºåº“ã€æ‰¹é‡å¯¼å…¥ä¸ç§»åº“ç­‰å†™æ“ä½œã€‚
    </p>
    <div class="grid md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="text-sm" id="label-email">é‚®ç®± (Email)</label>
        <input id="login-email" class="w-full p-2 border rounded" placeholder="your.name@example.com"/>
      </div>
      <div>
        <label class="text-sm" id="label-otp">éªŒè¯ç  (OTP)</label>
        <input id="login-otp" class="w-full p-2 border rounded" placeholder="6ä½æ•°å­—"/>
      </div>
      <div class="flex items-end gap-2">
        <button id="btn-send-otp"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded w-full md:w-auto"
                onclick="sendOtp()">å‘é€éªŒè¯ç </button>
        <span id="otp-countdown" class="text-sm text-gray-400"></span>
      </div>
      <div class="md:col-span-2">
        <button id="btn-verify"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full"
                onclick="verifyOtp()">éªŒè¯å¹¶ç™»å½•</button>
      </div>
    </div>
  </div>

  <!-- éç™½åå•æç¤º -->
  <div id="unauth-card"
       class="max-w-xl mx-auto bg-amber-50 border border-amber-200 text-amber-800 rounded-lg p-5 mb-6 hidden">
    <div class="font-semibold mb-1" id="unauth-title">æœªæˆæƒç”¨æˆ·æ— æ³•è¿›è¡Œå†™æ“ä½œ</div>
    <div class="text-sm" id="unauth-desc">
      å½“å‰é‚®ç®±æœªåœ¨ç™½åå•ä¸­ã€‚ä½ ä»å¯æµè§ˆâ€œåº“å­˜æ€»è§ˆ/æ“ä½œæ—¥å¿—â€ï¼Œä½†å…¥/å‡ºåº“ã€æ‰¹é‡å¯¼å…¥ã€ç§»åº“æ“ä½œå·²è¢«ç¦ç”¨ã€‚
    </div>
  </div>

  <!-- å½“å‰ç™»å½•é‚®ç®± -->
  <div class="text-center mb-6">
    <span class="text-sm text-gray-500" id="current-user-label">å½“å‰æ“ä½œç”¨æˆ·: </span>
    <span id="current-user" class="font-semibold">æœªç™»å½•</span>
    <button class="ml-2 text-sm text-blue-600 underline" id="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>

  <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
  <div class="mb-8 flex justify-center gap-2 border-b overflow-x-auto">
    <button id="inbound-tab"   class="tab-button active px-6 py-3 border-b-2 whitespace-nowrap" onclick="switchView('inbound')">å…¥åº“ç®¡ç†</button>
    <button id="outbound-tab"  class="tab-button px-6 py-3 border-b-2 whitespace-nowrap" onclick="switchView('outbound')">å‡ºåº“ç®¡ç†</button>
    <button id="return-tab"    class="tab-button px-6 py-3 border-b-2 whitespace-nowrap" onclick="switchView('return')">é€€åº“ç®¡ç†</button>
    <button id="transfer-tab"  class="tab-button px-6 py-3 border-b-2 whitespace-nowrap" onclick="switchView('transfer')">ç§»åº“ç®¡ç†</button>
    <button id="overview-tab"  class="tab-button px-6 py-3 border-b-2 whitespace-nowrap" onclick="switchView('overview')">åº“å­˜æ€»è§ˆ</button>
    <button id="logs-tab"      class="tab-button px-6 py-3 border-b-2 whitespace-nowrap" onclick="switchView('logs')">æ“ä½œæ—¥å¿— Logs</button>
  </div>

  <main id="app-main">

    <!-- å…¥åº“ç®¡ç† -->
    <section id="inbound-view">
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between gap-3">
          <div class="flex-1">
            <h2 class="text-xl font-bold mb-2" id="inbound-title">å…¥åº“ç®¡ç† (Inbound)</h2>
            <input id="inbound-search" class="w-full p-3 border rounded-lg"
                   placeholder="è¾“å…¥ å‹å·(Model) æˆ– åç§°(Name) æœç´¢..."/>
          </div>
          <button id="btn-inbound-showall" class="icon-btn w-full md:w-auto"
                  onclick="showAllFor('inbound')">ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨</button>
        </div>
      </div>

      <div id="inbound-result" class="space-y-4"></div>

      <!-- æ‰¹é‡å¯¼å…¥ï¼ˆå…¥åº“ï¼‰ -->
      <div class="bg-white p-6 rounded-lg shadow mt-8">
        <h3 class="text-lg font-semibold mb-3" id="batch-import-title">æ‰¹é‡å¯¼å…¥ CSV (Batch Import)</h3>
        <div class="flex items-center gap-3 flex-wrap">
          <button id="btn-batch-import"
                  onclick="document.getElementById('batch-upload').click()"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg w-full md:w-auto">
            é€‰æ‹© CSV æ–‡ä»¶å¹¶å¯¼å…¥
          </button>
          <input id="batch-upload" type="file" accept=".csv" class="hidden" onchange="handleBatchUpload(event)"/>
          <span class="text-sm text-gray-500" id="batch-import-hint">
            è¡¨å¤´ï¼šå‹å·, éƒ¨ä»¶åç§°, å•ä½, æ•°é‡, å­˜æ”¾åœ°ç‚¹, ä½¿ç”¨ä½ç½®, æè´¨, è¯´æ˜
          </span>
        </div>
      </div>
    </section>

    <!-- å‡ºåº“ç®¡ç† -->
    <section id="outbound-view" class="hidden">
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between gap-3">
          <div class="flex-1">
            <h2 class="text-xl font-bold mb-2" id="outbound-title">å‡ºåº“ç®¡ç† (Outbound)</h2>
            <input id="outbound-search" class="w-full p-3 border rounded-lg"
                   placeholder="è¾“å…¥ å‹å·(Model) æˆ– åç§°(Name) æœç´¢..."/>
          </div>
          <button id="btn-outbound-showall" class="icon-btn w-full md:w-auto"
                  onclick="showAllFor('outbound')">ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨</button>
        </div>
      </div>
      <div id="outbound-result" class="space-y-4"></div>
    </section>

    <!--é€€åº“ç®¡ç† -->
    <section id="return-view" class="hidden">
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between gap-3">
          <div class="flex-1">
            <h2 class="text-xl font-bold mb-2" id="return-title">é€€åº“ç®¡ç† (Return)</h2>
            <input id="return-search" class="w-full p-3 border rounded-lg"
                   placeholder="è¾“å…¥ å‹å·/åç§°/é¢†ç”¨äºº æœç´¢å‡ºåº“è®°å½•..."/>
          </div>
          <!-- å¦‚æœæƒ³åšâ€œæœ€è¿‘å‡ºåº“è®°å½•â€æŒ‰é’®ï¼Œå¯ä»¥åé¢å†åŠ  -->
        </div>
      </div>

      <!-- é€€åº“æœç´¢ç»“æœåŒºåŸŸ -->
      <div id="return-result" class="space-y-4"></div>
    </section>
   
    <!-- ç§»åº“ç®¡ç† -->
    <section id="transfer-view" class="hidden">
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between gap-3">
          <div class="flex-1">
            <h2 class="text-xl font-bold mb-2" id="transfer-title">ç§»åº“ç®¡ç† (Transfer)</h2>
            <input id="transfer-search" class="w-full p-3 border rounded-lg"
                   placeholder="è¾“å…¥ å‹å·(Model) æˆ– åç§°(Name) æœç´¢..."/>
          </div>
          <button id="btn-transfer-showall" class="icon-btn w-full md:w-auto"
                  onclick="showAllFor('transfer')">ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨</button>
        </div>
      </div>

      <div id="transfer-result" class="space-y-4"></div>

      <!-- æ‰¹é‡ç§»åº“ -->
      <div class="bg-white p-6 rounded-lg shadow mt-8">
        <h3 class="text-lg font-semibold mb-3" id="batch-transfer-title">æ‰¹é‡ç§»åº“ CSV (Batch Transfer)</h3>
        <div class="flex items-center gap-3 flex-wrap">
          <button id="btn-batch-transfer"
                  onclick="document.getElementById('batch-transfer').click()"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg w-full md:w-auto">
            é€‰æ‹© CSV æ–‡ä»¶å¹¶å¯¼å…¥
          </button>
          <input id="batch-transfer" type="file" accept=".csv" class="hidden" onchange="handleBatchTransfer(event)"/>
          <span class="text-sm text-gray-500" id="batch-transfer-hint">
            è¡¨å¤´ï¼šå‹å·, åç§°, å•ä½, æ•°é‡, åŸå­˜æ”¾åœ°ç‚¹, æ–°å­˜æ”¾åœ°ç‚¹, ä½¿ç”¨ä½ç½®, æè´¨, å¤‡æ³¨
          </span>
        </div>
      </div>
    </section>

    <!-- åº“å­˜æ€»è§ˆ -->
    <section id="overview-view" class="hidden">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex items-center justify-between gap-3">
          <div class="flex-1">
            <h2 class="text-2xl font-bold mb-2" id="overview-title">åº“å­˜æ€»è§ˆ (Inventory Overview)</h2>
            <input id="overview-search" class="w-full p-3 mb-4 border rounded-lg"
                   placeholder="è¾“å…¥ å‹å· æˆ– åç§° æœç´¢..."/>
          </div>
          <div class="flex gap-2">
            <button id="btn-export-overview" class="icon-btn w-full md:w-auto" onclick="exportOverviewCSV()">â¬‡ï¸ å¯¼å‡º CSV</button>
            <button id="btn-refresh" class="icon-btn w-full md:w-auto" onclick="reloadOverview()">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>

        <div class="table-container border rounded-lg overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="px-6 py-3 text-left" id="th-model">å‹å·</th>
                <th class="px-6 py-3 text-left" id="th-name">åç§°</th>
                <th class="px-6 py-3 text-left" id="th-unit">å•ä½</th>
                <th class="px-6 py-3 text-left" id="th-stock">åº“å­˜</th>
                <th class="px-6 py-3 text-left" id="th-storage">å­˜æ”¾åœ°ç‚¹</th>
                <th class="px-6 py-3 text-left" id="th-location">ä½¿ç”¨ä½ç½®</th>
                <th class="px-6 py-3 text-left" id="th-material">æè´¨</th>
                <th class="px-6 py-3 text-left" id="th-comments">å¤‡æ³¨</th>
              </tr>
            </thead>
            <tbody id="inventory-table-body"></tbody>
          </table>
        </div>
        <div id="overview-pager" class="mt-3 mb-3 text-center space-x-2"></div>
      </div>
    </section>

    <!-- æ“ä½œæ—¥å¿— -->
    <section id="logs-view" class="hidden">
      <div class="bg-white p-6 rounded-lg shadow mb-3">
        <div class="flex flex-col md:flex-row md:items-end gap-3">
          <div class="flex-1">
            <h2 class="text-2xl font-bold mb-2" id="logs-title">æ“ä½œæ—¥å¿— (Logs)</h2>
            <input id="logs-search" class="w-full p-3 border rounded-lg"
                   placeholder="æœç´¢ï¼šå‹å·/åç§°/åº“ä½/é¢†å–äºº/æ“ä½œè€…/å¤‡æ³¨"/>
          </div>

          <div>
            <label class="text-sm block mb-1" id="logs-type-label">ç±»å‹ (Type)</label>
            <select id="logs-type" class="p-2 border rounded w-48">
              <option value="ALL" id="logs-opt-all">å…¨éƒ¨ All</option>
              <option value="INBOUND" id="logs-opt-in">å…¥åº“ Inbound</option>
              <option value="OUTBOUND" id="logs-opt-out">å‡ºåº“ Outbound</option>
              <option value="TRANSFER" id="logs-opt-tr">ç§»åº“ Transfer</option>
              <option value="RETURN"   id="logs-opt-ret">é€€åº“ Return</option>
            </select>
          </div>

          <div class="flex items-end gap-2">
            <div>
              <label class="text-sm block mb-1" id="logs-date-start-label">å¼€å§‹æ—¥æœŸ (Start)</label>
              <input type="date" id="logs-date-start" class="p-2 border rounded w-36">
            </div>
            <div>
              <label class="text-sm block mb-1" id="logs-date-end-label">ç»“æŸæ—¥æœŸ (End)</label>
              <input type="date" id="logs-date-end" class="p-2 border rounded w-36">
            </div>
            <button id="btn-logs-datefilter" class="icon-btn" onclick="applyLogsFilter()">ğŸ•’ ç­›é€‰</button>
          </div>

          <div class="flex gap-2">
            <button id="btn-logs-export" class="icon-btn" onclick="exportLogsCSV()">â¬‡ï¸ å¯¼å‡º CSV</button>
            <button id="btn-logs-refresh" class="icon-btn" onclick="reloadLogs()">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>
      </div>

      <div class="bg-white p-2 rounded-lg shadow">
        <div class="table-container border rounded-lg overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="px-4 py-3 text-left" id="logs-th-time">æ—¶é—´</th>
                <th class="px-4 py-3 text-left" id="logs-th-type">ç±»å‹</th>
                <th class="px-4 py-3 text-left" id="logs-th-model">å‹å·</th>
                <th class="px-4 py-3 text-left" id="logs-th-name">åç§°</th>
                <th class="px-4 py-3 text-left" id="logs-th-unit">å•ä½</th>
                <th class="px-4 py-3 text-left" id="logs-th-qty">æ•°é‡</th>
                <th class="px-4 py-3 text-left" id="logs-th-storage">åº“ä½</th>
                <th class="px-4 py-3 text-left" id="logs-th-from">From</th>
                <th class="px-4 py-3 text-left" id="logs-th-to">To</th>
                <th class="px-4 py-3 text-left" id="logs-th-recipient">é¢†å–äºº</th>
                <th class="px-4 py-3 text-left" id="logs-th-operator">æ“ä½œè€…</th>
                <th class="px-4 py-3 text-left" id="logs-th-comments">å¤‡æ³¨</th>
              </tr>
            </thead>
            <tbody id="logs-table-body"></tbody>
          </table>
          </div>
        <div id="logs-pager" class="mt-3 text-center space-x-2"></div>
        <div id="logs-empty" class="text-center text-gray-500 py-6 hidden">æš‚æ— æ—¥å¿—</div>
      </div>
    </section>

  </main>
</div>

<script>
/* ========= â‘  Supabase åˆå§‹åŒ– ========= */
const SUPA_URL = "https://lnfcshqbohiuwcmbeftj.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuZmNzaHFib2hpdXdjbWJlZnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTczNTAsImV4cCI6MjA3NjM3MzM1MH0.ItSsnRjYm3TxgC6AuDFqamOPtj74EXMNYnefc-Xe4bM";

const supa = window.supabase.createClient(
  SUPA_URL,
  SUPA_KEY,
  {
    auth:{
      persistSession:true,
      autoRefreshToken:true,
      detectSessionInUrl:true
    }
  }
);

/* ========= â‘¡ I18N è¯­è¨€åŒ… & è¯­è¨€åˆ‡æ¢ ========= */
let LANG = (localStorage.getItem("scivic_lang")||"zh");

const I18N = {
  zh: {
    app_title:"SCIVIC ECIM - åº“å­˜ç®¡ç†ç³»ç»Ÿ",
    app_subtitle:"Inventory Management System",
    current_user_label:"å½“å‰æ“ä½œç”¨æˆ·",
    logout:"é€€å‡ºç™»å½•",
    login_title:"ç™»å½• (Email + éªŒè¯ç )",
    login_desc:"è¾“å…¥é‚®ç®±è·å–éªŒè¯ç ï¼ŒéªŒè¯æˆåŠŸåç™»å½•ã€‚ä»…ç™½åå•é‚®ç®±å¯è¿›è¡Œå…¥/å‡ºåº“ã€æ‰¹é‡å¯¼å…¥ä¸ç§»åº“ç­‰å†™æ“ä½œã€‚",
    label_email:"é‚®ç®± (Email)",
    label_otp:"éªŒè¯ç  (OTP)",
    send_otp:"å‘é€éªŒè¯ç ",
    verify_login:"éªŒè¯å¹¶ç™»å½•",
    unauthorized_title:"æœªæˆæƒç”¨æˆ·æ— æ³•è¿›è¡Œå†™æ“ä½œ",
    unauthorized_desc:"å½“å‰é‚®ç®±æœªåœ¨ç™½åå•ä¸­ã€‚ä½ ä»å¯æµè§ˆâ€œåº“å­˜æ€»è§ˆ/æ“ä½œæ—¥å¿—â€ï¼Œä½†å…¥/å‡ºåº“ã€æ‰¹é‡å¯¼å…¥ã€ç§»åº“æ“ä½œå·²è¢«ç¦ç”¨ã€‚",
    tab_inbound:"å…¥åº“ç®¡ç†",
    tab_outbound:"å‡ºåº“ç®¡ç†",
    tab_transfer:"ç§»åº“ç®¡ç†",
    tab_overview:"åº“å­˜æ€»è§ˆ",
    tab_logs:"æ“ä½œæ—¥å¿— Logs",
    tab_return:"é€€åº“ç®¡ç†",
    inbound_title:"å…¥åº“ç®¡ç† (Inbound)",
    outbound_title:"å‡ºåº“ç®¡ç† (Outbound)",
    transfer_title:"ç§»åº“ç®¡ç† (Transfer)",
    overview_title:"åº“å­˜æ€»è§ˆ (Inventory Overview)",
    return_title:"é€€åº“ç®¡ç† (Return)",
    show_all:"æ˜¾ç¤ºå…¨éƒ¨",
    batch_import_title:"æ‰¹é‡å¯¼å…¥ CSV (Batch Import)",
    batch_import_hint:"è¡¨å¤´ï¼šå‹å·, éƒ¨ä»¶åç§°, å•ä½, æ•°é‡, å­˜æ”¾åœ°ç‚¹, ä½¿ç”¨ä½ç½®, æè´¨, è¯´æ˜",
    batch_transfer_title:"æ‰¹é‡ç§»åº“ CSV (Batch Transfer)",
    batch_transfer_hint:"è¡¨å¤´ï¼šå‹å·, åç§°, å•ä½, æ•°é‡, åŸå­˜æ”¾åœ°ç‚¹, æ–°å­˜æ”¾åœ°ç‚¹, ä½¿ç”¨ä½ç½®, æè´¨, å¤‡æ³¨",
    overview_search_placeholder:"è¾“å…¥ å‹å· æˆ– åç§° æœç´¢...",
    export_csv:"å¯¼å‡º CSV",
    refresh:"åˆ·æ–°",
    th_model:"å‹å·",
    th_name:"åç§°",
    th_unit:"å•ä½",
    th_stock:"åº“å­˜",
    th_storage:"å­˜æ”¾åœ°ç‚¹",
    th_location:"ä½¿ç”¨ä½ç½®",
    th_material:"æè´¨",
    th_comments:"å¤‡æ³¨",
    logs_title:"æ“ä½œæ—¥å¿— (Logs)",
    logs_search_ph:"æœç´¢ï¼šå‹å·/åç§°/åº“ä½/é¢†å–äºº/æ“ä½œè€…/å¤‡æ³¨",
    logs_type_label:"ç±»å‹ (Type)",
    logs_opt_all:"å…¨éƒ¨ All",
    logs_opt_in:"å…¥åº“ Inbound",
    logs_opt_out:"å‡ºåº“ Outbound",
    logs_opt_tr:"ç§»åº“ Transfer",
    logs_opt_ret:"é€€åº“ Return",
    logs_export:"å¯¼å‡º CSV",
    logs_refresh:"åˆ·æ–°",
    logs_empty:"æš‚æ— æ—¥å¿—",
    logs_th_time:"æ—¶é—´",
    logs_th_type:"ç±»å‹",
    logs_th_model:"å‹å·",
    logs_th_name:"åç§°",
    logs_th_unit:"å•ä½",
    logs_th_qty:"æ•°é‡",
    logs_th_storage:"åº“ä½",
    logs_th_from:"From",
    logs_th_to:"To",
    logs_th_recipient:"é¢†å–äºº",
    logs_th_operator:"æ“ä½œè€…",
    logs_th_comments:"å¤‡æ³¨",
    logs_date_start:"å¼€å§‹æ—¥æœŸ (Start)",
    logs_date_end:"ç»“æŸæ—¥æœŸ (End)",
    logs_filter_btn:"ç­›é€‰",
    tip_need_email:"è¯·è¾“å…¥é‚®ç®±",
    tip_need_email_code:"è¯·è¾“å…¥é‚®ç®±ä¸éªŒè¯ç ",
    tip_otp_sent:"éªŒè¯ç å·²å‘é€",
    tip_otp_retry:"è¯·å‹¿é¢‘ç¹å‘é€ï¼Œ10ç§’åå¯é‡è¯•",
    tip_need_login:"è¯·å…ˆç™»å½•",
    tip_not_authorized:"æœªæˆæƒç”¨æˆ·æ— æ³•è¿›è¡Œè¯¥æ“ä½œ",
    tip_invalid_qty:"è¯·è¾“å…¥æœ‰æ•ˆå…¥åº“æ•°é‡",
    tip_need_recipient:"è¯·è¾“å…¥é¢†ç”¨äºº",
    tip_stock_not_enough:"åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ {stock}",
    tip_new_storage:"è¯·è¾“å…¥æ–°å­˜æ”¾åœ°ç‚¹",
    done_export_overview:"å·²å¯¼å‡º {n} æ¡",
    done_export_logs:"å·²å¯¼å‡º {n} æ¡æ—¥å¿—",
    no_match_or_0:"æœªæ‰¾åˆ°ç›¸å…³ç‰©æ–™ï¼ˆæˆ–åº“å­˜ä¸º 0ï¼‰",
    not_repeat_click:"è¯·å‹¿é‡å¤ç‚¹å‡»ï¼Œ5ç§’åå¯é‡è¯•",
    inbound_here:"å…¥åº“åˆ°æ­¤åœ°ç‚¹",
    outbound_confirm:"ç¡®è®¤å‡ºåº“",
    transfer_confirm:"æ‰§è¡Œç§»åº“",
    return_search_ph:"è¾“å…¥ å‹å·/åç§°/é¢†ç”¨äºº æœç´¢å‡ºåº“è®°å½•...",
    return_confirm:"ç¡®è®¤é€€åº“"
  },
  en: {
    app_title:"SCIVIC ECIM - Inventory Management System",
    app_subtitle:"Inventory Management System",
    current_user_label:"Current user",
    logout:"Log out",
    login_title:"Sign in (Email + OTP)",
    login_desc:"Enter your email to receive a code. Only whitelisted emails can perform inbound/outbound, batch import and transfer.",
    label_email:"Email",
    label_otp:"OTP",
    send_otp:"Send Code",
    verify_login:"Verify & Sign In",
    unauthorized_title:"Unauthorized users cannot write",
    unauthorized_desc:"Your email is not whitelisted. You can still browse Overview/Logs; inbound/outbound/transfer are disabled.",
    tab_inbound:"Inbound",
    tab_outbound:"Outbound",
    tab_transfer:"Transfer",
    tab_overview:"Overview",
    tab_logs:"Logs",
    tab_return:"Return",
    inbound_title:"Inbound",
    outbound_title:"Outbound",
    transfer_title:"Transfer",
    overview_title:"Inventory Overview",
    return_title:"Return",
    show_all:"Show all",
    batch_import_title:"Batch Import CSV",
    batch_import_hint:"Headers: Model, Name, Unit, Quantity, Storage, Location, Material, Comments",
    batch_transfer_title:"Batch Transfer CSV",
    batch_transfer_hint:"Headers: Model, Name, Unit, Quantity, From Storage, To Storage, Location, Material, Comments",
    overview_search_placeholder:"Search by Model or Name...",
    export_csv:"Export CSV",
    refresh:"Refresh",
    th_model:"Model",
    th_name:"Name",
    th_unit:"Unit",
    th_stock:"Stock",
    th_storage:"Storage",
    th_location:"Location",
    th_material:"Material",
    th_comments:"Comments",
    logs_title:"Logs",
    logs_search_ph:"Search: model/name/storage/recipient/operator/comments",
    logs_type_label:"Type",
    logs_opt_all:"All",
    logs_opt_in:"Inbound",
    logs_opt_out:"Outbound",
    logs_opt_tr:"Transfer",
    logs_opt_ret:"Return",
    logs_export:"Export CSV",
    logs_refresh:"Refresh",
    logs_empty:"No records",
    logs_th_time:"Time",
    logs_th_type:"Type",
    logs_th_model:"Model",
    logs_th_name:"Name",
    logs_th_unit:"Unit",
    logs_th_qty:"Qty",
    logs_th_storage:"Storage",
    logs_th_from:"From",
    logs_th_to:"To",
    logs_th_recipient:"Recipient",
    logs_th_operator:"Operator",
    logs_th_comments:"Comments",
    logs_date_start:"Start date",
    logs_date_end:"End date",
    logs_filter_btn:"Filter",
    tip_need_email:"Please enter your email",
    tip_need_email_code:"Enter email and OTP",
    tip_otp_sent:"Code sent",
    tip_otp_retry:"Retry in 10s",
    tip_need_login:"Please sign in first",
    tip_not_authorized:"Not authorized",
    tip_invalid_qty:"Enter a valid quantity",
    tip_need_recipient:"Enter recipient",
    tip_stock_not_enough:"Not enough stock, current {stock}",
    tip_new_storage:"Enter new storage",
    done_export_overview:"Exported {n} rows",
    done_export_logs:"Exported {n} log rows",
    no_match_or_0:"No match (or stock = 0)",
    not_repeat_click:"Retry in 5s",
    inbound_here:"Inbound Here",
    outbound_confirm:"Confirm Outbound",
    transfer_confirm:"Confirm Transfer",
    return_search_ph:"Search outbound logs by model / name / recipient...",
    return_confirm:"Confirm Return"
  }
};

function T(key, vars={}){
  const dict=I18N[LANG]||I18N.zh;
  let s=dict[key]||I18N.zh[key]||key;
  Object.keys(vars).forEach(k=>{
    s=s.replace(new RegExp("\\{"+k+"\\}","g"), String(vars[k]));
  });
  return s;
}

function setLang(lang){
  LANG=(lang==="en")?"en":"zh";
  localStorage.setItem("scivic_lang",LANG);
  applyI18n();
}

function injectLangToggle(){
  const div=document.createElement("div");
  div.style.position="fixed";
  div.style.right="16px";
  div.style.top="16px";
  div.style.zIndex="1001";
  div.innerHTML=`
    <div class="bg-white/90 backdrop-blur rounded-full shadow px-2 py-1 border">
      <button id="lang-zh" class="px-2 ${LANG==='zh'?'font-bold':''}">ä¸­æ–‡</button>
      <span class="text-gray-300">|</span>
      <button id="lang-en" class="px-2 ${LANG==='en'?'font-bold':''}">EN</button>
    </div>`;
  document.body.appendChild(div);
  document.getElementById("lang-zh").onclick=()=>setLang("zh");
  document.getElementById("lang-en").onclick=()=>setLang("en");
}

function applyI18n(){
  byId("app-title").textContent=T("app_title");
  byId("app-subtitle").textContent=T("app_subtitle");

  byId("login-title").textContent=T("login_title");
  byId("login-desc").textContent=T("login_desc");
  byId("label-email").textContent=T("label_email");
  byId("label-otp").textContent=T("label_otp");
  byId("btn-send-otp").textContent=T("send_otp");
  byId("btn-verify").textContent=T("verify_login");
  byId("current-user-label").textContent=T("current_user_label")+": ";
  byId("btn-logout").textContent=T("logout");
  byId("unauth-title").textContent=T("unauthorized_title");
  byId("unauth-desc").textContent=T("unauthorized_desc");

  byId("inbound-tab").textContent=T("tab_inbound");
  byId("outbound-tab").textContent=T("tab_outbound");
  byId("transfer-tab").textContent=T("tab_transfer");
  byId("overview-tab").textContent=T("tab_overview");
  byId("logs-tab").textContent=T("tab_logs");
  byId("return-tab").textContent=T("tab_return");

  byId("inbound-title").textContent=T("inbound_title");
  byId("outbound-title").textContent=T("outbound_title");
  byId("transfer-title").textContent=T("transfer_title");
  byId("overview-title").textContent=T("overview_title");
  byId("return-title").textContent=T("return_title");

  byId("btn-inbound-showall").textContent="ğŸ‘ï¸ "+T("show_all");
  byId("btn-outbound-showall").textContent="ğŸ‘ï¸ "+T("show_all");
  byId("btn-transfer-showall").textContent="ğŸ‘ï¸ "+T("show_all");

  byId("batch-import-title").textContent=T("batch_import_title");
  byId("batch-import-hint").textContent=T("batch_import_hint");
  byId("batch-transfer-title").textContent=T("batch_transfer_title");
  byId("batch-transfer-hint").textContent=T("batch_transfer_hint");

  byId("overview-search").placeholder=T("overview_search_placeholder");
  byId("return-search").placeholder=T("return_search_ph");
  byId("th-model").textContent=T("th_model");
  byId("th-name").textContent=T("th_name");
  byId("th-unit").textContent=T("th_unit");
  byId("th-stock").textContent=T("th_stock");
  byId("th-storage").textContent=T("th_storage");
  byId("th-location").textContent=T("th_location");
  byId("th-material").textContent=T("th_material");
  byId("th-comments").textContent=T("th_comments");

  byId("btn-export-overview").textContent="â¬‡ï¸ "+T("export_csv");
  byId("btn-refresh").textContent="ğŸ”„ "+T("refresh");

  byId("logs-title").textContent=T("logs_title");
  byId("logs-search").placeholder=T("logs_search_ph");
  byId("logs-type-label").textContent=T("logs_type_label");
  byId("logs-opt-all").textContent=T("logs_opt_all");
  byId("logs-opt-in").textContent=T("logs_opt_in");
  byId("logs-opt-out").textContent=T("logs_opt_out");
  byId("logs-opt-tr").textContent=T("logs_opt_tr");
  byId("logs-opt-ret").textContent = T("logs_opt_ret");
  byId("btn-logs-export").textContent="â¬‡ï¸ "+T("logs_export");
  byId("btn-logs-refresh").textContent="ğŸ”„ "+T("logs_refresh");

  byId("logs-th-time").textContent=T("logs_th_time");
  byId("logs-th-type").textContent=T("logs_th_type");
  byId("logs-th-model").textContent=T("logs_th_model");
  byId("logs-th-name").textContent=T("logs_th_name");
  byId("logs-th-unit").textContent=T("logs_th_unit");
  byId("logs-th-qty").textContent=T("logs_th_qty");
  byId("logs-th-storage").textContent=T("logs_th_storage");
  byId("logs-th-from").textContent=T("logs_th_from");
  byId("logs-th-to").textContent=T("logs_th_to");
  byId("logs-th-recipient").textContent=T("logs_th_recipient");
  byId("logs-th-operator").textContent=T("logs_th_operator");
  byId("logs-th-comments").textContent=T("logs_th_comments");

  byId("logs-empty").textContent=T("logs_empty");
  byId("logs-date-start-label").textContent=T("logs_date_start");
  byId("logs-date-end-label").textContent=T("logs_date_end");
  byId("btn-logs-datefilter").textContent="ğŸ•’ "+T("logs_filter_btn");
}

document.addEventListener("DOMContentLoaded", injectLangToggle);
document.addEventListener("DOMContentLoaded", applyI18n);

/* ========= â‘¢ DOM/å·¥å…·å‡½æ•° ========= */
function byId(id){ return document.getElementById(id); }

function formatLocalTime(utcString){
  if(!utcString) return "";
  try{
    const date=new Date(utcString);
    const y=date.getFullYear();
    const m=String(date.getMonth()+1).padStart(2,"0");
    const d=String(date.getDate()).padStart(2,"0");
    const hh=String(date.getHours()).padStart(2,"0");
    const mm=String(date.getMinutes()).padStart(2,"0");
    const ss=String(date.getSeconds()).padStart(2,"0");
    return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
  }catch(err){
    console.warn("æ—¶é—´è½¬æ¢å¤±è´¥:",utcString,err);
    return utcString;
  }
}

const showNotification=(msg,type="success")=>{
  const n=byId("notification");
  n.textContent=msg;
  n.className=`notification show ${type}`;
  setTimeout(()=>n.classList.remove("show"),3000);
};

/* ========= â‘£ ç™»å½•çŠ¶æ€ / ç™½åå• / ä¼šè¯ä¿æŒ ========= */

let CURRENT_EMAIL="";
let AUTHORIZED=false;

// ç™»å½•æœ‰æ•ˆæœŸï¼š24 å°æ—¶
const LOGIN_TTL_MS = 24 * 60 * 60 * 1000;

function setCurrentUser(email){
  CURRENT_EMAIL=email||"";
  byId("current-user").textContent=CURRENT_EMAIL||"æœªç™»å½•";
}

// ä¿å­˜é‚®ç®± + è¿‡æœŸæ—¶é—´åˆ° localStorage
function rememberLogin(email){
  const expiresAt=Date.now()+LOGIN_TTL_MS;
  localStorage.setItem("scivic_auth_email",email);
  localStorage.setItem("scivic_auth_expires",String(expiresAt));
}

// æ¢å¤æœ¬åœ°ç™»å½•æ€
async function restoreLoginFromLocal(){
  const savedEmail=localStorage.getItem("scivic_auth_email")||"";
  const exp=Number(localStorage.getItem("scivic_auth_expires")||0);
  if(!savedEmail||!exp) return;
  if(Date.now()>=exp){
    localStorage.removeItem("scivic_auth_email");
    localStorage.removeItem("scivic_auth_expires");
    return;
  }

  // æœªè¿‡æœŸ -> è®¤ä¸ºå·²ç™»å½•
  setCurrentUser(savedEmail);
  byId("login-card").classList.add("hidden");

  // æ£€æŸ¥ dict ç™½åå•
  const { data:wl } = await supa
    .from("dict")
    .select("email,enabled")
    .eq("email", savedEmail)
    .eq("enabled", true)
    .limit(1);

  AUTHORIZED=Array.isArray(wl)&&wl.length>0;
  if(!AUTHORIZED){
    byId("unauth-card").classList.remove("hidden");
  }
}

// OTP å†·å´é”
const __opLocks = new Map();
function acquireOpLock(action,key,ms=5000){
  const now=Date.now();
  const k=`${action}::${key}`;
  const until=__opLocks.get(k);
  if(until && until>now) return false;
  const expireAt=now+ms;
  __opLocks.set(k,expireAt);
  setTimeout(()=>{
    if(__opLocks.get(k)===expireAt) __opLocks.delete(k);
  },ms+50);
  return true;
}

function releaseBtnLater(btn){
  if(!btn) return;
  const oldHTML=btn.innerHTML;
  btn.classList.add("disabled");
  btn.innerHTML="â³";
  setTimeout(()=>{
    btn.classList.remove("disabled");
    btn.innerHTML=oldHTML;
  },5000);
}

// å‘é€ OTP
async function sendOtp(){
  const email=(byId("login-email").value||"").trim().toLowerCase();
  if(!email){
    showNotification(T("tip_need_email"),"error");
    return;
  }
  if(!acquireOpLock('otp',email,10000)){
    showNotification(T("tip_otp_retry"),"error");
    return;
  }
  byId("btn-send-otp").classList.add("disabled");

  const { error } = await supa.auth.signInWithOtp({
    email,
    options:{ shouldCreateUser:false }
  });
  if(error){
    byId("btn-send-otp").classList.remove("disabled");
    showNotification(error.message||"å‘é€å¤±è´¥","error");
    return;
  }

  startCountdown(60);
  showNotification(T("tip_otp_sent"));
}

// å€’è®¡æ—¶
let countdownTimer=null;
function startCountdown(sec){
  const btn=byId("btn-send-otp");
  const label=byId("otp-countdown");
  let left=sec;
  label.textContent=`${left}s`;
  clearInterval(countdownTimer);
  countdownTimer=setInterval(()=>{
    left--;
    if(left<=0){
      clearInterval(countdownTimer);
      label.textContent="";
      btn.classList.remove("disabled");
    }else{
      label.textContent=`${left}s`;
    }
  },1000);
}

// éªŒè¯ OTP
async function verifyOtp(){
  const email=(byId("login-email").value||"").trim().toLowerCase();
  const code =(byId("login-otp").value||"").trim();
  if(!email||!code){
    showNotification(T("tip_need_email_code"),"error");
    return;
  }
  const { error } = await supa.auth.verifyOtp({
    type:"email",
    email,
    token:code
  });
  if(error){
    showNotification(error.message||"ç™»å½•å¤±è´¥","error");
    return;
  }

  setCurrentUser(email);

  // ç™½åå•æ ¡éªŒ
  const { data:wl } = await supa
    .from("dict")
    .select("email,enabled")
    .eq("email", email)
    .eq("enabled", true)
    .limit(1);

  AUTHORIZED=Array.isArray(wl)&&wl.length>0;

  byId("login-card").classList.add("hidden");
  byId("unauth-card").classList.toggle("hidden", AUTHORIZED);

  // è®°ä½ç™»å½• 24h
  rememberLogin(email);

  showNotification(
    AUTHORIZED
      ? "ç™»å½•æˆåŠŸï¼Œå·²æˆæƒ"
      : "ç™»å½•æˆåŠŸï¼Œä½†éç™½åå•",
    "success"
  );
}

// é€€å‡ºç™»å½•
async function logout(){
  await supa.auth.signOut();
  AUTHORIZED=false;
  setCurrentUser("");
  byId("login-card").classList.remove("hidden");
  byId("unauth-card").classList.add("hidden");

  localStorage.removeItem("scivic_auth_email");
  localStorage.removeItem("scivic_auth_expires");

  showNotification(T("logout"));
}

// é¡µé¢å¯åŠ¨æ—¶å°è¯•æ¢å¤ç™»å½•
document.addEventListener("DOMContentLoaded", async ()=>{
  await restoreLoginFromLocal();

  if(!CURRENT_EMAIL){
    // fallback: Supabase session
    const { data } = await supa.auth.getSession();
    const emailFromSession=data?.session?.user?.email;
    if(emailFromSession){
      setCurrentUser(emailFromSession);

      const { data:wl } = await supa
        .from("dict")
        .select("email,enabled")
        .eq("email", emailFromSession)
        .eq("enabled", true)
        .limit(1);
      AUTHORIZED=Array.isArray(wl)&&wl.length>0;

      byId("login-card").classList.add("hidden");
      if(!AUTHORIZED){
        byId("unauth-card").classList.remove("hidden");
      }

      // åŒæ­¥24hæœ‰æ•ˆæœŸ
      rememberLogin(emailFromSession);
    }
  }
});

/* ========= â‘¤ å…¨å±€åº“å­˜ç¼“å­˜ ========= */
let masterItemList=[];   // [{model,name,unit,storage,location,material,comments}, ...]
let stockByKey={};       // {"model@@storage": total}

/* ========= â‘¥ å°å·¥å…·å‡½æ•°ï¼ˆæœç´¢ / é«˜äº®ç­‰ï¼‰ ========= */
function safe(v){
  return (v===undefined||v===null||v==="") ? "-" : String(v);
}
function cssKey(m,s){
  return encodeURIComponent(`${m}@@${s||""}`);
}
function normStr(s){
  return (s||"")
    .toString()
    .toLowerCase()
    .replace(/[\s.\-_/\\_]+/g,"");
}
function highlightMatch(text, term){
  if(!term) return safe(text||"");
  const raw=text||"";
  const nText=normStr(raw);
  const nTerm=normStr(term);
  if(!nText.includes(nTerm)) return safe(raw);
  const pattern=new RegExp(
    term.split("")
      .map(ch=>{
        const esc=ch.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
        return `${esc}[\\s.\\-_/\\\\_]*`;
      })
      .join(""),
    "ig"
  );
  return raw.replace(pattern, m=>`<mark>${m}</mark>`);
}
function filterPositiveStock(list){
  return (list||[]).filter(it=>{
    const key=`${it.model}@@${it.storage||""}`;
    const stock=Number(stockByKey[key]||0);
    return stock>0;
  });
}
function findByTerm(term){
  const q=normStr(term);
  if(!q) return [];
  return (masterItemList||[]).filter(i=>{
    const combined=[
      i.model,i.name,i.storage,i.location,i.material,i.comments
    ].join("|");
    return normStr(combined).includes(q);
  });
}

/* ========= â‘¦ åˆå§‹åŒ–è¯»å– overview ========= */
async function loadOverview(){
  const { data, error } = await supa.from("overview").select("*");
  if(error){
    showNotification("åˆå§‹åŒ–åº“å­˜å¤±è´¥","error");
    return;
  }

  masterItemList=(data||[]).map(it=>({
    model:it.model||"",
    name:it.name||"",
    unit:it.unit||"PCS",
    storage:it.storage||"",
    location:it.location||"",
    material:it.material||"",
    comments:it.comments||""
  }));

  stockByKey={};
  (data||[]).forEach(it=>{
    const key=`${it.model}@@${it.storage||""}`;
    stockByKey[key]=Number(it.total||0);
  });

  switchView('inbound');
  renderInventoryTable();
}
window.onload=loadOverview;

// åå°å®šæ—¶åˆ·æ–°ï¼ˆ10åˆ†é’Ÿï¼‰
let verTimer=null;
function startVersionPolling(){
  if(verTimer) clearInterval(verTimer);
  verTimer=setInterval(async ()=>{
    await reloadOverview(true);
  },600000);
}
startVersionPolling();

async function reloadOverview(silent=false){
  const btn=byId("btn-refresh");
  const old=btn?btn.innerHTML:"";
  if(btn && !silent){
    btn.classList.add("disabled");
    btn.innerHTML="â³";
  }
  const { data, error } = await supa.from("overview").select("*");
  if(error){
    if(!silent) showNotification("åˆ·æ–°å¤±è´¥ï¼ˆç½‘ç»œ/æƒé™ï¼‰","error");
    if(btn){
      btn.classList.remove("disabled");
      btn.innerHTML=old;
    }
    return;
  }

  masterItemList=(data||[]).map(it=>({
    model:it.model||"",
    name:it.name||"",
    unit:it.unit||"PCS",
    storage:it.storage||"",
    location:it.location||"",
    material:it.material||"",
    comments:it.comments||""
  }));

  stockByKey={};
  (data||[]).forEach(it=>{
    const key=`${it.model}@@${it.storage||""}`;
    stockByKey[key]=Number(it.total||0);
  });

  const overviewVisible=!byId("overview-view").classList.contains("hidden");
  if(overviewVisible) renderInventoryTable();

  if(!silent){
    showNotification(T("refresh"));
    if(btn){
      btn.classList.remove("disabled");
      btn.innerHTML=old;
    }
  }
}

/* ========= â‘§ è§†å›¾åˆ‡æ¢ ========= */
function switchView(view){
  ["inbound","outbound","return","transfer","overview","logs"].forEach(v=>{
    const sec=byId(v+"-view");
    const tab=byId(v+"-tab");
    if(!sec||!tab) return;
    if(v===view){
      sec.classList.remove("hidden");
      tab.classList.add("active");
    }else{
      sec.classList.add("hidden");
      tab.classList.remove("active");
    }
  });

  if(view==="overview"){
    renderInventoryTable();
  }
  if(view==="logs"){
    if(!_logsLoadedOnce) reloadLogs();
    else applyLogsFilter();
  }
}

/* ========= â‘¨ åº“å­˜æ€»è§ˆæ¸²æŸ“ ========= */
let _overviewPage = 1;
const OVERVIEW_PER_PAGE = 100;  // æ¯é¡µæ˜¾ç¤º 100 æ¡
let _overviewFiltered = [];
function renderInventoryTable(list = masterItemList, term = "") {
  const tb = byId("inventory-table-body");
  if (!tb) return;

  // æœç´¢å…³é”®å­—ï¼ˆç”¨äºé«˜äº®ï¼‰
  const keyword = (term || "").trim().toLowerCase();

  function highlight(text) {
    if (!keyword) return safe(text || "");
    const esc = keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return safe(text || "").replace(
      new RegExp(`(${esc})`, "gi"),
      `<mark class="bg-yellow-200 text-black">$1</mark>`
    );
  }

  // æ­£å¸¸è¿‡æ»¤ï¼ˆä¿ç•™æ­£åº“å­˜ï¼‰
  const base = filterPositiveStock(list || []);

  // ä¿å­˜è¿‡æ»¤ç»“æœï¼Œç”¨äºåˆ†é¡µ
  _overviewFiltered = base;
  const total = _overviewFiltered.length;

  // åˆ†é¡µè®¡ç®—
  const start = (_overviewPage - 1) * OVERVIEW_PER_PAGE;
  const end = Math.min(start + OVERVIEW_PER_PAGE, total);
  const pageRows = _overviewFiltered.slice(start, end);

  // æ¸…ç©ºè¡¨æ ¼
  tb.innerHTML = "";

  // ç©ºçŠ¶æ€
  if (!pageRows.length) {
    tb.innerHTML = `<tr><td colspan="8" class="py-6 text-center text-gray-500">
      ${LANG === "en" ? "No inventory" : "æš‚æ— åº“å­˜"}
    </td></tr>`;
    return;
  }

  // æ¸²æŸ“æ¯ä¸€è¡Œ
  pageRows.forEach((it) => {
    const key = `${it.model}@@${it.storage || ""}`;
    const stock = Number(stockByKey[key] || 0);

    tb.insertAdjacentHTML("beforeend", `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-3">${highlight(it.model)}</td>
        <td class="px-6 py-3">${highlight(it.name)}</td>
        <td class="px-6 py-3">${safe(it.unit || "PCS")}</td>
        <td class="px-6 py-3 font-semibold ${stock < 0 ? "text-red-600" : ""}">${stock}</td>
        <td class="px-6 py-3">${highlight(it.storage)}</td>
        <td class="px-6 py-3">${highlight(it.location)}</td>
        <td class="px-6 py-3">${highlight(it.material)}</td>
        <td class="px-6 py-3">${highlight(it.comments)}</td>
      </tr>
    `);
  });

  // æ¸²æŸ“åˆ†é¡µæŒ‰é’®
  renderOverviewPager(total);
}

function renderOverviewPager(total) {
  const pager = byId("overview-pager");
  if (!pager) return;

  const pages = Math.ceil(total / OVERVIEW_PER_PAGE);
  if (pages <= 1) {
    pager.innerHTML = "";
    return;
  }

  pager.innerHTML = `
    <button onclick="changeOverviewPage(-1)" 
      class="px-3 py-1 border rounded ${_overviewPage === 1 ? 'opacity-40' : ''}">
      â¬…ï¸ Prev
    </button>

    <span class="text-sm">
      Page ${_overviewPage} / ${pages} ï¼ˆå…± ${total} æ¡ï¼‰
    </span>

    <button onclick="changeOverviewPage(1)" 
      class="px-3 py-1 border rounded ${_overviewPage === pages ? 'opacity-40' : ''}">
      Next â¡ï¸
    </button>
  `;
}

function changeOverviewPage(delta) {
  const total = _overviewFiltered.length;
  const pages = Math.ceil(total / OVERVIEW_PER_PAGE);

  const newPage = _overviewPage + delta;
  if (newPage < 1 || newPage > pages) return;

  _overviewPage = newPage;
  renderInventoryTable(_overviewFiltered, byId("overview-search").value.trim().toLowerCase());
}

// åº“å­˜æ€»è§ˆæœç´¢æ¡†
document.addEventListener("DOMContentLoaded",()=>{
  const overviewSearch=byId("overview-search");
  if(!overviewSearch){
    console.warn("âš ï¸ #overview-search æœªæ‰¾åˆ°");
    return;
  }
  overviewSearch.addEventListener("keyup",(e)=>{
    const raw=e.target.value||"";
    _overviewPage = 1; 
    const results=findByTerm(raw);
    renderInventoryTable(results, raw);
  });
  if(masterItemList && masterItemList.length>0){
    renderInventoryTable(masterItemList,"");
  }
});

/* ========= â‘© å¯¼å‡ºåº“å­˜ CSV ========= */
function exportOverviewCSV(){
  const term=(byId("overview-search").value||"").toLowerCase().trim();
  const base=term
    ? masterItemList.filter(i=>
        (i.name||"").toLowerCase().includes(term) ||
        (i.model||"").toLowerCase().includes(term)||
        (i.storage||"").toLowerCase().includes(term)
      )
    : masterItemList;

  const list=filterPositiveStock(base);
  const rows=[["model","name","unit","total","storage","location","material","comments"]];
  list.forEach(it=>{
    const key=`${it.model}@@${it.storage||""}`;
    const stock=Number(stockByKey[key]||0);
    rows.push([
      it.model||"",
      it.name||"",
      it.unit||"PCS",
      stock,
      it.storage||"",
      it.location||"",
      it.material||"",
      it.comments||""
    ]);
  });

  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`inventory_overview_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  showNotification(T("done_export_overview",{n:list.length}));
}

/* ========= 11. â€œæ˜¾ç¤ºå…¨éƒ¨â€ç»™å…¥/å‡º/ç§»åº“ ========= */
function showAllFor(which){
  const list=filterPositiveStock(masterItemList);
  if(which==='inbound'){
    inboundRenderList(list,"");
  }else if(which==='outbound'){
    outboundRenderList(list,"");
  }else if(which==='transfer'){
    transferRenderList(list,"");
  }
}

/* ========= 12. å…¥åº“ ========= */
const inboundSearch=byId("inbound-search");
const inboundResult=byId("inbound-result");

inboundSearch.addEventListener("keyup",(e)=>{
  const raw=e.target.value||"";
  if(!normStr(raw)){
    inboundResult.innerHTML="";
    return;
  }
  inboundRenderList(findByTerm(raw), raw);
});

let lastInboundKey="";
let lastInboundTime=0;

function inboundRenderList(results, term=""){
  inboundResult.innerHTML="";
  const filtered=filterPositiveStock(results||[]);
  if(!filtered||filtered.length===0){
    // æ–°å¢ + å…¥åº“
    inboundResult.innerHTML=`
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-bold mb-3">${
          LANG==='en'?'New Item + Inbound':'æ–°å¢ç‰©æ–™å¹¶å…¥åº“'
        }</h3>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm">${LANG==='en'?'Model No.':'å‹å· *'}</label>
            <input id="new-model" class="w-full p-2 border rounded" value="${term||""}"/>
          </div>
          <div>
            <label class="text-sm">${LANG==='en'?'Part Name':'éƒ¨ä»¶åç§° *'}</label>
            <input id="new-name" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label class="text-sm">${LANG==='en'?'Unit':'å•ä½'}</label>
            <input id="new-unit" class="w-full p-2 border rounded" placeholder="${LANG==='en'?'Default PCS':'é»˜è®¤ PCS'}"/>
          </div>
          <div>
            <label class="text-sm">${LANG==='en'?'Quantity':'æ•°é‡ *'}</label>
            <input id="new-qty" type="number" min="1" step="1" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label class="text-sm">${LANG==='en'?'Storage':'å­˜æ”¾åœ°ç‚¹ *'}</label>
            <input id="new-storage" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label class="text-sm">${LANG==='en'?'Location':'ä½¿ç”¨ä½ç½®'}</label>
            <input id="new-location" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label class="text-sm">${LANG==='en'?'Material':'æè´¨'}</label>
            <input id="new-material" class="w-full p-2 border rounded"/>
          </div>
          <div class="md:col-span-2">
            <label class="text-sm">${LANG==='en'?'Comments':'å¤‡æ³¨'}</label>
            <textarea id="new-comments" rows="2" class="w-full p-2 border rounded"></textarea>
          </div>
        </div>
        <div class="mt-4 flex gap-3">
          <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full md:w-auto"
                  onclick="addNewItemAndInbound()">${
            LANG==='en'?'Create & Inbound':'æ–°å¢å¹¶å…¥åº“'
          }</button>
          <button class="bg-gray-100 px-4 py-2 rounded w-full md:w-auto"
                  onclick="inboundSearch.value=''; inboundResult.innerHTML=''">${
            LANG==='en'?'Cancel':'å–æ¶ˆ'
          }</button>
        </div>
      </div>`;
    return;
  }

  filtered.forEach(item=>{
    const key=`${item.model}@@${item.storage||""}`;
    const stock=Number(stockByKey[key]||0);
    const k=cssKey(item.model,item.storage);

    inboundResult.insertAdjacentHTML("beforeend",`
      <div class="bg-white p-6 rounded-lg shadow mb-3">
        <h3 class="text-lg font-bold mb-2">
          ${highlightMatch(item.name,term)}
          <span class="text-gray-500">(${highlightMatch(item.model,term)})</span>
        </h3>
        <div class="grid md:grid-cols-3 gap-2 text-sm">
          <div><b>${LANG==='en'?'Unit':'å•ä½'}:</b> ${safe(item.unit||"PCS")}</div>
          <div><b>${LANG==='en'?'Stock':'åº“å­˜'}:</b> ${stock}</div>
          <div><b>${LANG==='en'?'Material':'æè´¨'}:</b> ${highlightMatch(item.material,term)}</div>
          <div><b>${LANG==='en'?'Storage':'å­˜æ”¾åœ°ç‚¹'}:</b> ${highlightMatch(item.storage,term)}</div>
          <div><b>${LANG==='en'?'Location':'ä½¿ç”¨ä½ç½®'}:</b> ${highlightMatch(item.location,term)}</div>
          <div class="md:col-span-3"><b>${LANG==='en'?'Comments':'å¤‡æ³¨'}:</b> ${highlightMatch(item.comments,term)}</div>
        </div>
        <div class="mt-3 flex items-center gap-3 flex-wrap">
          <input id="inbound-qty-${k}" type="number" min="1" step="1"
                 class="w-32 p-2 border rounded"
                 placeholder="${LANG==='en'?'Inbound Qty':'å…¥åº“æ•°é‡'}"/>
          <input id="inbound-comments-${k}" class="w-80 p-2 border rounded"
                 placeholder="${LANG==='en'?'Comments':'å¤‡æ³¨'}"/>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full md:w-auto"
                  onclick="handleInbound('${encodeURIComponent(item.model)}','${encodeURIComponent(item.storage||"")}', this)">
            ${T("inbound_here")}
          </button>
        </div>
      </div>
    `);
  });
}

async function handleInbound(modelEnc, storageEnc, btn){
  const model=decodeURIComponent(modelEnc);
  const storage=decodeURIComponent(storageEnc||"");
  const key=`${model}@@${storage}`;
  const k=cssKey(model, storage);

  // 5ç§’å»æŠ–ï¼Œé˜²é‡å¤å¤šæ¬¡åŒç‰©æ–™
  const nowMs=Date.now();
  const userEmail=CURRENT_EMAIL || "guest";
  const thisKey=`${userEmail}@@${key}`;
  if(thisKey===lastInboundKey && nowMs-lastInboundTime<5000){
    showNotification("è¯¥ç‰©æ–™åˆšåˆšå…¥åº“ï¼Œè¯·å‹¿é‡å¤æäº¤","error");
    return;
  }
  lastInboundKey=thisKey;
  lastInboundTime=nowMs;

  // æŒ‰é’®å»é‡
  if(btn.dataset.locked==="1"){
    showNotification(T("not_repeat_click"),"error");
    return;
  }
  btn.dataset.locked="1";
  setTimeout(()=>{btn.dataset.locked="0";},5000);

  if(btn.classList.contains("disabled")) return;
  btn.classList.add("disabled");
  const oldText=btn.innerHTML;
  btn.innerHTML="â³";

  const qtyEl=byId(`inbound-qty-${k}`);
  const cmtEl=byId(`inbound-comments-${k}`);
  const qty=parseInt(qtyEl?.value||"",10);
  const comments=(cmtEl?.value||"").trim();

  try {
    if(!CURRENT_EMAIL){
      showNotification(T("tip_need_login"),"error");
      return;
    }
    if(!AUTHORIZED){
      showNotification(T("tip_not_authorized"),"error");
      return;
    }
    if(!qty||qty<=0){
      showNotification(T("tip_invalid_qty"),"error");
      return;
    }

    // å…ƒæ•°æ®
    const base=masterItemList.find(i=>i.model===model && (i.storage||"")===storage);

    // RPC: å…¥åº“äº‹åŠ¡
    const { data, error } = await supa.rpc("fn_inbound_tx",{
      p_model: model,
      p_storage: storage,
      p_name: base?.name || "",
      p_qty: qty,
      p_operator: userEmail,
      p_unit: base?.unit || "PCS",
      p_location: base?.location || "",
      p_material: base?.material || "",
      p_comments: comments || ""
    });
    if(error) throw new Error(error.message||"å…¥åº“å¤±è´¥");

    // æ›´æ–°æœ¬åœ°åº“å­˜
    const nextTotal=data?.new_total ?? null;
    if(nextTotal!==null){
      stockByKey[key]=nextTotal;
    }

    // æ¸…è¾“å…¥
    if(qtyEl) qtyEl.value="";
    if(cmtEl) cmtEl.value="";

    btn.classList.remove("disabled");
    btn.innerHTML=oldText || T("inbound_here");

    renderInventoryTable();
    _logsLoadedOnce=false;

    showNotification(
      (LANG==='en'
        ? `Inbound +${qty} to `
        : `å…¥åº“æˆåŠŸ +${qty} è‡³ `)+(storage||"(blank)"),
      "success"
    );
  } catch(e){
    btn.classList.remove("disabled");
    btn.innerHTML=oldText || T("inbound_here");
    showNotification("å…¥åº“å¤±è´¥ï¼š" + (e.message||e),"error");
  } finally {
    btn.classList.remove("disabled");
    btn.innerHTML=oldText || T("inbound_here");
  }
}

// æ–°å»ºç‰©æ–™å¹¶å…¥åº“
async function addNewItemAndInbound(){
  if(!CURRENT_EMAIL){
    showNotification(T("tip_need_login"),"error");
    return;
  }
  if(!AUTHORIZED){
    showNotification(T("tip_not_authorized"),"error");
    return;
  }

  const model   = byId("new-model").value.trim();
  const name    = byId("new-name").value.trim();
  const unit    = (byId("new-unit").value.trim()||"PCS");
  const qty     = parseInt(byId("new-qty").value||"",10);
  const storage = byId("new-storage").value.trim();
  const location= byId("new-location").value.trim();
  const material= byId("new-material").value.trim();
  const comments= byId("new-comments").value.trim();

  if(!model||!name||!qty||qty<=0||!storage){
    showNotification(
      LANG==='en'
        ? 'Fill required fields: model/name/qty/storage'
        : 'è¯·å¡«å†™å¿…å¡«é¡¹ï¼šå‹å·ã€åç§°ã€æ•°é‡ã€å­˜æ”¾åœ°ç‚¹',
      "error"
    );
    return;
  }

  try {
    const { data, error } = await supa.rpc("fn_inbound_tx",{
      p_model: model,
      p_storage: storage,
      p_name: name,
      p_qty: qty,
      p_operator: CURRENT_EMAIL,
      p_unit: unit,
      p_location: location,
      p_material: material,
      p_comments: comments
    });
    if(error) throw new Error(error.message||"æ–°å¢+å…¥åº“å¤±è´¥");

    // æœ¬åœ°å†…å­˜è¿½åŠ 
    if(!masterItemList.find(i=>i.model===model && (i.storage||"")===storage)){
      masterItemList.push({
        model,
        name,
        unit,
        storage,
        location,
        material,
        comments
      });
    }

    // åº“å­˜åŒæ­¥
    const key=`${model}@@${storage||""}`;
    const nextTotal=data?.new_total ?? null;
    if(nextTotal!==null){
      stockByKey[key]=nextTotal;
    }

    inboundSearch.value="";
    inboundResult.innerHTML="";

    showNotification(
      (LANG==='en'
        ? `Created "${name}" & inbounded ${qty} to `
        : `æ–°å¢â€œ${name}â€ å¹¶å…¥åº“ ${qty} åˆ° `)+storage,
      "success"
    );

    renderInventoryTable();
    _logsLoadedOnce=false;
  } catch(e){
    showNotification("æ–°å¢å¹¶å…¥åº“å¤±è´¥ï¼š" + (e.message||e), "error");
  }
}

/* ========= 13. å‡ºåº“ ========= */
const outboundSearch=byId("outbound-search");
const outboundResult=byId("outbound-result");

outboundSearch.addEventListener("keyup",(e)=>{
  const raw=e.target.value||"";
  if(!normStr(raw)){
    outboundResult.innerHTML="";
    return;
  }
  outboundRenderList(findByTerm(raw), raw);
});

function outboundRenderList(results, term=""){
  outboundResult.innerHTML="";
  const filtered=filterPositiveStock(results||[]);
  if(!filtered||filtered.length===0){
    outboundResult.innerHTML=`
      <div class="text-gray-500">${T("no_match_or_0")}</div>`;
    return;
  }

  filtered.forEach(item=>{
    const key=`${item.model}@@${item.storage||""}`;
    const stock=Number(stockByKey[key]||0);
    const k=cssKey(item.model,item.storage);

    outboundResult.insertAdjacentHTML("beforeend",`
      <div class="bg-white p-6 rounded-lg shadow mb-3">
        <h3 class="text-lg font-bold mb-2">
          ${highlightMatch(item.name,term)}
          <span class="text-gray-500">
            (${highlightMatch(item.model,term)})
          </span>
        </h3>
        <div class="grid md:grid-cols-3 gap-2 text-sm">
          <div><b>${LANG==='en'?'Unit':'å•ä½'}:</b> ${safe(item.unit||"PCS")}</div>
          <div><b>${LANG==='en'?'Stock':'åº“å­˜'}:</b> ${stock}</div>
          <div><b>${LANG==='en'?'Material':'æè´¨'}:</b> ${highlightMatch(item.material,term)}</div>
          <div><b>${LANG==='en'?'Storage':'å­˜æ”¾åœ°ç‚¹'}:</b> ${highlightMatch(item.storage,term)}</div>
          <div><b>${LANG==='en'?'Location':'ä½¿ç”¨ä½ç½®'}:</b> ${highlightMatch(item.location,term)}</div>
          <div class="md:col-span-3"><b>${LANG==='en'?'Comments':'å¤‡æ³¨'}:</b> ${highlightMatch(item.comments,term)}</div>
        </div>
        <div class="mt-3 flex flex-col md:flex-row md:items-center gap-3">
          <input id="outbound-qty-${k}" type="number" min="1" step="1"
                 class="w-40 p-2 border rounded"
                 placeholder="${LANG==='en'?'Outbound Qty':'å‡ºåº“æ•°é‡'}"/>
          <input id="outbound-recipient-${k}" class="w-60 p-2 border rounded"
                 placeholder="${LANG==='en'?'Recipient *':'é¢†ç”¨äºº (Recipient) *'}"/>
          <input id="outbound-comments-${k}" class="w-80 p-2 border rounded"
                 placeholder="${LANG==='en'?'Comments':'å¤‡æ³¨'}"/>
          <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded w-full md:w-auto"
                  onclick="handleOutbound('${encodeURIComponent(item.model)}','${encodeURIComponent(item.storage||"")}', this)">
            ${T("outbound_confirm")}
          </button>
        </div>
      </div>
    `);
  });
}

async function handleOutbound(modelEnc,storageEnc,btn){
  const model=decodeURIComponent(modelEnc);
  const storage=decodeURIComponent(storageEnc||"");
  const k=cssKey(model,storage);

  if(!acquireOpLock('outbound', model+'@@'+storage, 5000)){
    showNotification(T("not_repeat_click"),"error");
    return;
  }
  releaseBtnLater(btn);

  if(!CURRENT_EMAIL){
    showNotification(T("tip_need_login"),"error");
    return;
  }
  if(!AUTHORIZED){
    showNotification(T("tip_not_authorized"),"error");
    return;
  }

  const qtyEl=byId(`outbound-qty-${k}`);
  const recEl=byId(`outbound-recipient-${k}`);
  const cmtEl=byId(`outbound-comments-${k}`);

  const qty=parseInt(qtyEl?.value||"",10);
  const recipient=(recEl?.value||"").trim();
  const comments=(cmtEl?.value||"").trim();

  const key=`${model}@@${storage}`;
  const stock=Number(stockByKey[key]||0);

  if(!qty||qty<=0){
    showNotification(T("tip_invalid_qty"),"error");
    return;
  }
  if(!recipient){
    showNotification(T("tip_need_recipient"),"error");
    return;
  }
  if(qty>stock){
    showNotification(T("tip_stock_not_enough",{stock}),"error");
    return;
  }

  const base=masterItemList.find(i=>i.model===model && (i.storage||"")===storage);

  try {
    // RPC: å‡ºåº“äº‹åŠ¡
    const { data, error } = await supa.rpc("fn_outbound_tx",{
      p_model:model,
      p_storage:storage,
      p_name: base?.name||"",
      p_qty: qty,
      p_operator: CURRENT_EMAIL,
      p_unit: base?.unit||"PCS",
      p_location: base?.location||"",
      p_material: base?.material||"",
      p_comments: comments||"",
      p_recipient: recipient||""
    });
    if(error) throw new Error(error.message||"å‡ºåº“å¤±è´¥");

    const nextTotal=data?.new_total ?? null;
    if(nextTotal!==null){
      stockByKey[key]=nextTotal;
    }

    // æ¸…è¾“å…¥
    if(qtyEl) qtyEl.value="";
    if(recEl) recEl.value="";
    if(cmtEl) cmtEl.value="";

    showNotification(
      (LANG==='en'
        ? `Outbound -${qty} from `
        : `å‡ºåº“æˆåŠŸ -${qty} ä» `)+(storage||"(blank)"),
      "success"
    );

    renderInventoryTable();
    _logsLoadedOnce=false;
  }catch(e){
    showNotification("å‡ºåº“å¤±è´¥ï¼š" + (e.message||e),"error");
  }
}

/* ========= 13.1 é€€åº“ç®¡ç†ï¼ˆåŸºäº logs_all çš„ OUTBOUND è®°å½•ï¼‰ ========= */

const returnSearch = byId("return-search");
const returnResult = byId("return-result");

// ç¼“å­˜å½“å‰é€€åº“åˆ—è¡¨ï¼Œç”¨ä¸‹æ ‡ç´¢å¼•ç»™ handleReturn ç”¨
let _returnList = [];

// é€€åº“æœç´¢ï¼šæŒ‰ å‹å· / åç§° / é¢†ç”¨äºº åœ¨ OUTBOUND æ—¥å¿—ä¸­æ¨¡ç³ŠåŒ¹é…
returnSearch.addEventListener("keyup", async (e)=>{
  const raw = e.target.value || "";
  const term = raw.trim().toLowerCase();

  if(!term){
    returnResult.innerHTML = "";
    _returnList = [];
    return;
  }

  await loadReturnList(term);
});

// ç¡®ä¿æ—¥å¿—å·²åŠ è½½ï¼ˆåˆ©ç”¨ç°æœ‰ reloadLogs / _logsCacheï¼‰
async function ensureLogsLoadedForReturn(){
  if(_logsLoadedOnce) return;
  await reloadLogs();      // ä¼šä» logs_all è¯»æœ€å¤š 50000 æ¡
}

// ä» _logsCache ä¸­ç­›é€‰ type = OUTBOUND ä¸”åŒ¹é…æœç´¢è¯
async function loadReturnList(term){
  await ensureLogsLoadedForReturn();

  const list = (_logsCache || []).filter(r=>{
    if(r.type !== "OUTBOUND") return false;
    const combined = [
      r.model, r.name, r.storage,
      r.recipient, r.operator, r.comments
    ].join("|").toLowerCase();
    return combined.includes(term);
  });

  renderReturnList(list, term);
}

function renderReturnList(list, term=""){
  returnResult.innerHTML = "";
  _returnList = list || [];

  if(!_returnList.length){
    returnResult.innerHTML = `<div class="text-gray-500">${
      LANG==='en'
        ? "No outbound record found"
        : "æœªæ‰¾åˆ°ç›¸å…³å‡ºåº“è®°å½•"
    }</div>`;
    return;
  }

  _returnList.forEach((r, idx)=>{
    const key = `${r.model||""}@@${r.storage||""}`;
    const stock = Number(stockByKey[key] || 0);
    const timeStr = formatLocalTime(r.created_at);

    returnResult.insertAdjacentHTML("beforeend",`
      <div class="bg-white p-6 rounded-lg shadow mb-3">
        <h3 class="text-lg font-bold mb-2">
          ${highlightMatch(r.name||"", term)}
          <span class="text-gray-500">
            (${highlightMatch(r.model||"", term)})
          </span>
        </h3>

        <div class="grid md:grid-cols-3 gap-2 text-sm">
          <div><b>${LANG==='en'?'Unit':'å•ä½'}:</b> ${safe(r.unit||"PCS")}</div>
          <div><b>${LANG==='en'?'Outbound Qty':'å‡ºåº“æ•°é‡'}:</b> ${safe(r.quantity)}</div>
          <div><b>${LANG==='en'?'Current Stock':'å½“å‰åº“å­˜'}:</b> ${stock}</div>
          <div><b>${LANG==='en'?'Storage':'åº“ä½'}:</b> ${highlightMatch(r.storage||"", term)}</div>
          <div><b>${LANG==='en'?'Recipient':'é¢†ç”¨äºº'}:</b> ${highlightMatch(r.recipient||"", term)}</div>
          <div><b>${LANG==='en'?'Time':'æ—¶é—´'}:</b> ${safe(timeStr)}</div>
          <div class="md:col-span-3">
            <b>${LANG==='en'?'Comments':'å¤‡æ³¨'}:</b> ${highlightMatch(r.comments||"", term)}
          </div>
        </div>

        <div class="mt-3 flex flex-col md:flex-row md:items-center gap-3">
          <input id="return-qty-${idx}" type="number" min="1" step="1"
                 class="w-40 p-2 border rounded"
                 placeholder="${LANG==='en'?'Return Qty':'é€€åº“æ•°é‡'}"/>
          <input id="return-comments-${idx}" class="w-80 p-2 border rounded"
                 placeholder="${LANG==='en'?'Comments (optional)':'å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰'}"/>
          <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded w-full md:w-auto"
                  onclick="handleReturn(${idx}, this)">
            ${T("return_confirm")}
          </button>
        </div>
      </div>
    `);
  });
}

// é€€åº“ç¡®è®¤ï¼šå†™å…¥ returns + æ›´æ–° overview.total + å†™å…¥ logs_all(type='RETURN')
async function handleReturn(idx, btn){
  const row = _returnList[idx];
  if(!row){
    showNotification(LANG==='en'?"Record not found":"è®°å½•ä¸å­˜åœ¨","error");
    return;
  }

  const model   = row.model || "";
  const storage = row.storage || "";
  const name    = row.name   || "";
  const unit    = row.unit   || "PCS";
  const recipient = row.recipient || "";

  if(!acquireOpLock("return", `${model}@@${storage}@@${idx}`, 5000)){
    showNotification(T("not_repeat_click"),"error");
    return;
  }
  releaseBtnLater(btn);

  if(!CURRENT_EMAIL){
    showNotification(T("tip_need_login"),"error");
    return;
  }
  if(!AUTHORIZED){
    showNotification(T("tip_not_authorized"),"error");
    return;
  }

  const qtyEl = byId(`return-qty-${idx}`);
  const cmtEl = byId(`return-comments-${idx}`);

  const qty = parseInt(qtyEl?.value || "", 10);
  const comments = (cmtEl?.value || "").trim();

  if(!qty || qty <= 0){
    showNotification(T("tip_invalid_qty"),"error");
    return;
  }

  // å°è¯•ä» overview å…ƒæ•°æ®ä¸­æ‹¿ location / material
  const base = masterItemList.find(i => i.model===model && (i.storage||"")===storage);

  try{
    const { data, error } = await supa.rpc("fn_return_tx", {
      p_model: model,
      p_storage: storage,
      p_name: name,
      p_qty: qty,
      p_operator: CURRENT_EMAIL,
      p_unit: unit,
      p_location: base?.location || "",
      p_material: base?.material || "",
      p_comments: comments || "",
      p_recipient: recipient || ""
    });

    if(error) throw new Error(error.message || "Return failed");

    const key = `${model}@@${storage}`;
    const nextTotal = data?.new_total ?? null;
    if(nextTotal !== null){
      stockByKey[key] = nextTotal;
    }

    // æ¸…ç©ºè¾“å…¥æ¡†
    if(qtyEl) qtyEl.value = "";
    if(cmtEl) cmtEl.value = "";

    showNotification(
      (LANG==='en'
        ? `Returned ${qty} to `
        : `é€€åº“æˆåŠŸï¼Œæ•°é‡ ${qty}ï¼Œåº“ä½ `) + (storage || "(blank)"),
      "success"
    );

    // åˆ·æ–°åº“å­˜æ€»è§ˆ + ä¸‹æ¬¡é‡æ–°æ‹‰æ—¥å¿—
    renderInventoryTable();
    _logsLoadedOnce = false;
  }catch(e){
    console.error("Return failed:", e);
    showNotification(
      (LANG==='en'?"Return failed: ":"é€€åº“å¤±è´¥ï¼š") + (e.message || e),
      "error"
    );
  }
}

/* ========= 14. ç§»åº“ ========= */
const transferSearch=byId("transfer-search");
const transferResult=byId("transfer-result");

transferSearch.addEventListener("keyup",(e)=>{
  const raw=e.target.value||"";
  if(!normStr(raw)){
    transferResult.innerHTML="";
    return;
  }
  transferRenderList(findByTerm(raw), raw);
});

function transferRenderList(results,term=""){
  transferResult.innerHTML="";
  const filtered=filterPositiveStock(results||[]);
  if(!filtered||filtered.length===0){
    transferResult.innerHTML=`
      <div class="text-gray-500">${T("no_match_or_0")}</div>`;
    return;
  }

  filtered.forEach(item=>{
    const key=`${item.model}@@${item.storage||""}`;
    const stock=Number(stockByKey[key]||0);
    const k=cssKey(item.model,item.storage);

    transferResult.insertAdjacentHTML("beforeend",`
      <div class="bg-white p-6 rounded-lg shadow mb-3">
        <h3 class="text-lg font-bold mb-2">
          ${highlightMatch(item.name,term)}
          <span class="text-gray-500">
            (${highlightMatch(item.model,term)})
          </span>
        </h3>

        <div class="grid md:grid-cols-3 gap-2 text-sm">
          <div><b>${LANG==='en'?'Unit':'å•ä½'}:</b> ${safe(item.unit||"PCS")}</div>
          <div><b>${LANG==='en'?'Stock':'åº“å­˜'}:</b> ${stock}</div>
          <div><b>${LANG==='en'?'Material':'æè´¨'}:</b> ${highlightMatch(item.material,term)}</div>
          <div><b>${LANG==='en'?'From Storage':'å½“å‰å­˜æ”¾åœ°ç‚¹'}:</b> ${highlightMatch(item.storage,term)}</div>
          <div><b>${LANG==='en'?'Location':'ä½¿ç”¨ä½ç½®'}:</b> ${highlightMatch(item.location,term)}</div>
          <div class="md:col-span-3"><b>${LANG==='en'?'Comments':'å¤‡æ³¨'}:</b> ${highlightMatch(item.comments,term)}</div>
        </div>

        <div class="mt-3 flex flex-col md:flex-row md:items-center gap-3">
          <input id="transfer-qty-${k}" type="number" min="1" step="1"
                 class="w-32 p-2 border rounded"
                 placeholder="${LANG==='en'?'Qty to Move':'ç§»åº“æ•°é‡'}"/>
          <input id="transfer-to-${k}" class="w-60 p-2 border rounded"
                 placeholder="${LANG==='en'?'New Storage *':'æ–°å­˜æ”¾åœ°ç‚¹ *'}"/>
          <input id="transfer-comments-${k}" class="w-80 p-2 border rounded"
                 placeholder="${LANG==='en'?'Comments':'å¤‡æ³¨'}"/>
          <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded w-full md:w-auto"
                  onclick="handleTransfer('${encodeURIComponent(item.model)}','${encodeURIComponent(item.storage||"")}', this)">
            ${T("transfer_confirm")}
          </button>
        </div>
      </div>
    `);
  });
}

async function handleTransfer(modelEnc, fromStorageEnc, btn){
  const model=decodeURIComponent(modelEnc);
  const fromStorage=decodeURIComponent(fromStorageEnc||"");
  const k=cssKey(model,fromStorage);

  if(!acquireOpLock('transfer', model+'@@'+fromStorage, 5000)){
    showNotification(T("not_repeat_click"),"error");
    return;
  }
  releaseBtnLater(btn);

  if(!CURRENT_EMAIL){
    showNotification(T("tip_need_login"),"error");
    return;
  }
  if(!AUTHORIZED){
    showNotification(T("tip_not_authorized"),"error");
    return;
  }

  const qtyEl=byId(`transfer-qty-${k}`);
  const toEl =byId(`transfer-to-${k}`);
  const cmtEl=byId(`transfer-comments-${k}`);

  const qty=parseInt(qtyEl?.value||"",10);
  const toStorage=(toEl?.value||"").trim();
  const comments=(cmtEl?.value||"").trim();

  const keyFrom = `${model}@@${fromStorage}`;
  const stock   = Number(stockByKey[keyFrom]||0);

  if(!qty||qty<=0){
    showNotification(T("tip_invalid_qty"),"error");
    return;
  }
  if(qty>stock){
    showNotification(T("tip_stock_not_enough",{stock}),"error");
    return;
  }
  if(!toStorage){
    showNotification(T("tip_new_storage"),"error");
    return;
  }

  // æ‰¾å…ƒæ•°æ®
  const base=masterItemList.find(i=>i.model===model && (i.storage||"")===fromStorage);

  try{
    // RPC: ç§»åº“äº‹åŠ¡
    const { data, error } = await supa.rpc("fn_transfer_tx",{
      p_model: model,
      p_from_storage: fromStorage,
      p_to_storage: toStorage,
      p_name: base?.name || "",
      p_qty: qty,
      p_operator: CURRENT_EMAIL,
      p_unit: base?.unit || "PCS",
      p_location: base?.location || "",
      p_material: base?.material || "",
      p_comments: comments || ""
    });
    if(error) throw new Error(error.message||"ç§»åº“å¤±è´¥");

    // data é¢„æœŸå¯èƒ½åŒ…å« {new_total_from, new_total_to}
    const newFrom = data?.new_total_from;
    const newTo   = data?.new_total_to;

    if(newFrom!==undefined && newFrom!==null){
      stockByKey[keyFrom]=newFrom;
    }

    const keyTo = `${model}@@${toStorage}`;
    if(newTo!==undefined && newTo!==null){
      stockByKey[keyTo]=newTo;
    }

    // å¦‚æœæ–°åº“ä½ä¸å­˜åœ¨äº masterItemListï¼Œåˆ™è¡¥ä¸Š
    if(!masterItemList.find(i=>i.model===model && (i.storage||"")===toStorage)){
      masterItemList.push({
        model,
        name: base?.name || "",
        unit: base?.unit || "PCS",
        storage: toStorage,
        location: base?.location || "",
        material: base?.material || "",
        comments: base?.comments || comments || ""
      });
    }

    // æ¸…è¾“å…¥
    if(qtyEl) qtyEl.value="";
    if(toEl)  toEl.value="";
    if(cmtEl) cmtEl.value="";

    showNotification(
      (LANG==='en'
        ? `Transfer ${qty} â†’ `
        : `ç§»åº“æˆåŠŸ ${qty} â†’ `)+toStorage,
      "success"
    );

    renderInventoryTable();
    _logsLoadedOnce=false;
  }catch(e){
    showNotification("ç§»åº“å¤±è´¥ï¼š" + (e.message||e),"error");
  }
}

/* ========= 15. æ‰¹é‡å¯¼å…¥ï¼šå…¥åº“ CSV =========
  é¢„æœŸè¡¨å¤´ï¼ˆä¸­/è‹±å‡å¯æ¥å—ï¼‰ï¼š
  - å‹å· / model
  - éƒ¨ä»¶åç§° / name
  - å•ä½ / unit
  - æ•°é‡ / quantity
  - å­˜æ”¾åœ°ç‚¹ / storage
  - ä½¿ç”¨ä½ç½® / location
  - æè´¨ / material
  - è¯´æ˜ / comments
*/
async function handleBatchUpload(evt){
  if(!CURRENT_EMAIL){
    showNotification(T("tip_need_login"),"error");
    return;
  }
  if(!AUTHORIZED){
    showNotification(T("tip_not_authorized"),"error");
    return;
  }

  const file=evt.target.files[0];
  if(!file){
    return;
  }

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete: async (res)=>{
      const rows=res.data||[];
      let okCount=0;
      for(const r of rows){
        const model   = (r["å‹å·"]||r["model"]||r["Model"]||"").trim();
        const name    = (r["éƒ¨ä»¶åç§°"]||r["name"]||r["Name"]||"").trim();
        const unit    = (r["å•ä½"]||r["unit"]||r["Unit"]||"PCS").trim() || "PCS";
        const qtyRaw  = (r["æ•°é‡"]||r["quantity"]||r["Quantity"]||"").toString().trim();
        const qty     = parseInt(qtyRaw,10);
        const storage = (r["å­˜æ”¾åœ°ç‚¹"]||r["storage"]||r["Storage"]||"").trim();
        const location= (r["ä½¿ç”¨ä½ç½®"]||r["location"]||r["Location"]||"").trim();
        const material= (r["æè´¨"]||r["material"]||r["Material"]||"").trim();
        const comments= (r["è¯´æ˜"]||r["comments"]||r["Comments"]||"").trim();

        if(!model||!name||!qty||qty<=0||!storage){
          console.warn("è·³è¿‡æ— æ•ˆè¡Œ",r);
          continue;
        }

        try{
          const { data, error } = await supa.rpc("fn_inbound_tx",{
            p_model: model,
            p_storage: storage,
            p_name: name,
            p_qty: qty,
            p_operator: CURRENT_EMAIL,
            p_unit: unit||"PCS",
            p_location: location||"",
            p_material: material||"",
            p_comments: comments||""
          });
          if(error) throw new Error(error.message||"æ‰¹é‡å…¥åº“å¤±è´¥");

          // æ›´æ–°æœ¬åœ°ç¼“å­˜
          if(!masterItemList.find(i=>i.model===model && (i.storage||"")===storage)){
            masterItemList.push({
              model,
              name,
              unit: unit||"PCS",
              storage,
              location,
              material,
              comments
            });
          }
          const key=`${model}@@${storage||""}`;
          const nextTotal=data?.new_total ?? null;
          if(nextTotal!==null){
            stockByKey[key]=nextTotal;
          }
          okCount++;
        }catch(e){
          console.error("æ‰¹é‡å…¥åº“å¤±è´¥è¡Œ:",r,e);
        }
      }

      renderInventoryTable();
      _logsLoadedOnce=false;
      showNotification(`æ‰¹é‡å…¥åº“å®Œæˆ: æˆåŠŸ ${okCount} æ¡`,"success");
      evt.target.value="";
    }
  });
}

/* ========= 16. æ‰¹é‡ç§»åº“ CSV =========
  é¢„æœŸè¡¨å¤´ï¼š
  - å‹å· / model
  - åç§° / name
  - å•ä½ / unit
  - æ•°é‡ / quantity
  - åŸå­˜æ”¾åœ°ç‚¹ / from_storage
  - æ–°å­˜æ”¾åœ°ç‚¹ / to_storage
  - ä½¿ç”¨ä½ç½® / location
  - æè´¨ / material
  - å¤‡æ³¨ / comments
*/
async function handleBatchTransfer(evt){
  if(!CURRENT_EMAIL){
    showNotification(T("tip_need_login"),"error");
    return;
  }
  if(!AUTHORIZED){
    showNotification(T("tip_not_authorized"),"error");
    return;
  }

  const file=evt.target.files[0];
  if(!file){
    return;
  }

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete: async (res)=>{
      const rows=res.data||[];
      let okCount=0;
      for(const r of rows){
        const model   = (r["å‹å·"]||r["model"]||r["Model"]||"").trim();
        const qtyRaw  = (r["æ•°é‡"]||r["quantity"]||r["Quantity"]||"").toString().trim();
        const qty     = parseInt(qtyRaw,10);

        // æ”¯æŒâ€œåŸå­˜æ”¾åœ°ç‚¹/æ–°å­˜æ”¾åœ°ç‚¹â€
        const fromStorage = (r["åŸå­˜æ”¾åœ°ç‚¹"]||r["from_storage"]||r["From Storage"]||r["From"]||"").trim();
        const toStorage   = (r["æ–°å­˜æ”¾åœ°ç‚¹"]||r["to_storage"]||r["To Storage"]||r["To"]||"").trim();

        const unit    = (r["å•ä½"]||r["unit"]||r["Unit"]||"PCS").trim() || "PCS";
        const name    = (r["åç§°"]||r["name"]||r["Name"]||"").trim();
        const location= (r["ä½¿ç”¨ä½ç½®"]||r["location"]||r["Location"]||"").trim();
        const material= (r["æè´¨"]||r["material"]||r["Material"]||"").trim();
        const comments= (r["å¤‡æ³¨"]||r["comments"]||r["Comments"]||"").trim();

        if(!model||!qty||qty<=0||!fromStorage||!toStorage){
          console.warn("è·³è¿‡æ— æ•ˆç§»åº“è¡Œ",r);
          continue;
        }

        // æ‰¾å…ƒæ•°æ® (fromåº“ä½)
        const base=masterItemList.find(i=>i.model===model && (i.storage||"")===fromStorage);

        try{
          const { data, error } = await supa.rpc("fn_transfer_tx",{
            p_model: model,
            p_from_storage: fromStorage,
            p_to_storage: toStorage,
            p_name: name || base?.name || "",
            p_qty: qty,
            p_operator: CURRENT_EMAIL,
            p_unit: unit || base?.unit || "PCS",
            p_location: location || base?.location || "",
            p_material: material || base?.material || "",
            p_comments: comments || base?.comments || ""
          });
          if(error) throw new Error(error.message||"æ‰¹é‡ç§»åº“å¤±è´¥");

          // æ›´æ–°æœ¬åœ°ç¼“å­˜
          const keyFrom=`${model}@@${fromStorage}`;
          const keyTo  =`${model}@@${toStorage}`;
          const newFrom=data?.new_total_from;
          const newTo  =data?.new_total_to;

          if(newFrom!==undefined && newFrom!==null){
            stockByKey[keyFrom]=newFrom;
          }
          if(newTo!==undefined && newTo!==null){
            stockByKey[keyTo]=newTo;
          }

          // å¦‚æœæ–°åº“ä½åœ¨æœ¬åœ°ä¸å­˜åœ¨ï¼Œè¡¥ä¸Š
          if(!masterItemList.find(i=>i.model===model && (i.storage||"")===toStorage)){
            masterItemList.push({
              model,
              name: name || base?.name || "",
              unit: unit || base?.unit || "PCS",
              storage: toStorage,
              location: location || base?.location || "",
              material: material || base?.material || "",
              comments: comments || base?.comments || ""
            });
          }

          okCount++;
        }catch(e){
          console.error("æ‰¹é‡ç§»åº“å¤±è´¥è¡Œ:",r,e);
        }
      }

      renderInventoryTable();
      _logsLoadedOnce=false;
      showNotification(`æ‰¹é‡ç§»åº“å®Œæˆ: æˆåŠŸ ${okCount} æ¡`,"success");
      evt.target.value="";
    }
  });
}

/* ========= 17. æ“ä½œæ—¥å¿—ï¼ˆç›´æ¥è¯»å– log_allï¼Œæ”¯æŒå®Œæ•´æœç´¢ + æ—¥æœŸ + ç±»å‹è¿‡æ»¤ï¼‰ ========= */
let _logsCache = [];
let _logsPage = 1;          // å½“å‰é¡µ
const LOGS_PER_PAGE = 100;  // æ¯é¡µæ˜¾ç¤º 100 æ¡
let _logsFiltered = [];
let _logsLoadedOnce = false;

async function reloadLogs(){
  const btn = byId("btn-logs-refresh");
  const oldHTML = btn ? btn.innerHTML : "";
  if(btn){
    btn.classList.add("disabled");
    btn.innerHTML = "â³";
  }

  try {
    // âœ… æŒ‰ V4.0 æ¨¡å¼ï¼šä» logs_all è¡¨ç›´æ¥è¯»å–å®Œæ•´æ—¥å¿—
    const { data, error } = await supa
      .from("logs_all") //
      .select("*")
      .order("created_at", { ascending:false })
      .range(0, 50000); // âœ… é˜²æ­¢é»˜è®¤æœ€å¤š 1000 æ¡

    if(error) throw error;

    _logsCache = data || [];
    _logsLoadedOnce = true;
    applyLogsFilter();

  } catch(err){
    console.error("æ—¥å¿—åŠ è½½å¤±è´¥ï¼š", err);
    showNotification("æ—¥å¿—åŠ è½½å¤±è´¥ï¼š" + err.message, "error");
    } finally {
    // â¬…â¬…â¬… å…³é”®ç‚¹ï¼šå¿…é¡»åœ¨ finally æ¢å¤æŒ‰é’®
  }

  if(btn){
    btn.classList.remove("disabled");
    btn.innerHTML = oldHTML;
  }
}

function applyLogsFilter(){
  const term = (byId("logs-search").value||"").trim().toLowerCase();
  const type = byId("logs-type").value;
  const d1   = byId("logs-date-start").value;
  const d2   = byId("logs-date-end").value;

  _logsFiltered = _logsCache.filter(r=>{
    if(type !== "ALL" && r.type !== type) return false;

    if(d1 && r.created_at < d1) return false;
    if(d2 && r.created_at > (d2 + " 23:59:59")) return false;

    if(term){
      const combined = [
        r.model, r.name, r.unit, r.quantity, r.storage,
        r.from_storage, r.to_storage, r.recipient,
        r.operator, r.comments
      ].join("|").toLowerCase();
      if(!combined.includes(term)) return false;
    }
    return true;
  });
  _logsPage = 1; // â­ æ¯æ¬¡ç­›é€‰è‡ªåŠ¨è·³å›ç¬¬ 1 é¡µ
  renderLogsTable();
}

const logsSearch = byId("logs-search");
if (logsSearch) {
  logsSearch.addEventListener("keyup", () => {
    _logsPage = 1;          // â­ æœç´¢æ—¶è‡ªåŠ¨å›åˆ°ç¬¬ä¸€é¡µ
    applyLogsFilter();
  });
}

function renderLogsTable(){
  const body = byId("logs-table-body");
  const empty= byId("logs-empty");
    // â­â­ æœç´¢å…³é”®å­—é«˜äº®
  const keyword = (byId("logs-search").value || "").trim().toLowerCase();

  function highlight(text) {
    if (!keyword) return safe(text || "");
    const esc = keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return safe(text || "").replace(
      new RegExp(`(${esc})`, "gi"),
      `<mark class="bg-yellow-200 text-black">$1</mark>`
    );
  }
  body.innerHTML = "";

  if(!_logsFiltered.length){
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  // â­ åˆ†é¡µè®¡ç®—
  const total = _logsFiltered.length;
  const start = (_logsPage - 1) * LOGS_PER_PAGE;
  const end   = Math.min(start + LOGS_PER_PAGE, total);

  const pageRows = _logsFiltered.slice(start, end);

  // â­ æ¸²æŸ“å½“å‰é¡µ
  pageRows.forEach(r=>{
    body.insertAdjacentHTML("beforeend",`
      <tr class="hover:bg-gray-50">
        <td>${formatLocalTime(r.created_at)}</td>
        <td>${r.type||""}</td>
        <td>${highlight(r.model)}</td>
        <td>${highlight(r.name)}</td>
        <td>${r.unit||""}</td>
        <td>${r.quantity||""}</td>
        <td>${highlight(r.storage)}</td>
        <td>${highlight(r.from_storage)}</td>
        <td>${highlight(r.to_storage)}</td>
        <td>${highlight(r.recipient)}</td>
        <td>${r.operator||""}</td>
        <td>${r.comments||""}</td>
      </tr>
    `);
  });

  renderLogsPager(total);   // â­ åˆ†é¡µæŒ‰é’®
}

function renderLogsPager(total){
  const pager = byId("logs-pager");
  if(!pager) return;

  const pages = Math.ceil(total / LOGS_PER_PAGE);
  if(pages <= 1){
    pager.innerHTML = "";
    return;
  }

  pager.innerHTML = `
    <button onclick="changeLogsPage(-1)" 
            class="px-3 py-1 border rounded ${_logsPage===1?'opacity-40':''}">
      â¬…ï¸ Prev
    </button>

    <span class="text-sm">
      Page ${_logsPage} / ${pages} ï¼ˆå…± ${total} æ¡ï¼‰
    </span>

    <button onclick="changeLogsPage(1)" 
            class="px-3 py-1 border rounded ${_logsPage===pages?'opacity-40':''}">
      Next â¡ï¸
    </button>
  `;
}

function changeLogsPage(delta){
  const pages = Math.ceil(_logsFiltered.length / LOGS_PER_PAGE);
  const newPage = _logsPage + delta;

  if(newPage < 1 || newPage > pages) return;

  _logsPage = newPage;
  renderLogsTable();
}

// å¯¼å‡ºæ—¥å¿— CSVï¼ˆå½“å‰ç­›é€‰ç»“æœï¼‰
function exportLogs(){
  if(!_logsFiltered || _logsFiltered.length === 0){
    showNotification(LANG==='en'?"No data to export":"æ— å¯å¯¼å‡ºçš„è®°å½•","warning");
    return;
  }

  const rows = _logsFiltered.map(r => ({
    time: formatLocalTime(r.created_at),
    type: r.type || "",
    model: r.model || "",
    name: r.name || "",
    unit: r.unit || "",
    quantity: r.quantity || "",
    storage: r.storage || "",
    from_storage: r.from_storage || "",
    to_storage: r.to_storage || "",
    recipient: r.recipient || "",
    operator: r.operator || "",
    comments: r.comments || ""
  }));

 
   // âœ… ç”Ÿæˆ CSV å†…å®¹
  let csv = Papa.unparse(rows, { quotes: true });

  // âœ… åœ¨æœ€å‰é¢åŠ  UTF-8 BOM é˜²æ­¢ Excel ä¹±ç 
  csv = "\ufeff" + csv;

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "operation_logs_export.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  // âœ… å¯¼å‡ºæˆåŠŸæç¤º
  showNotification(`${LANG==='en'?'Exported':'å·²å¯¼å‡º'} ${rows.length} ${LANG==='en'?'records':'æ¡è®°å½•'}`, "success");
}

// âœ… ç»‘å®šæŒ‰é’®äº‹ä»¶
byId("btn-logs-export")?.addEventListener("click", exportLogs);

</script>

</body>
</html>
