<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SCIVIC ECIM Inventory (Azure V7.0)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body{font-family:Inter,"Microsoft YaHei",sans-serif;background:#f5f6fa;}
.btn{padding:8px 16px;border-radius:6px;font-weight:600;}
.btn-blue{background:#2563eb;color:white;}
.btn-blue:hover{background:#1e40af;}
input,select{border:1px solid #ccc;border-radius:6px;padding:6px 10px;width:100%;}
.card{background:white;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1);padding:16px;margin-bottom:16px;}
</style>
</head>
<body class="p-4">
<h1 class="text-2xl font-bold mb-4 text-center text-blue-800">SCIVIC ECIM 库存管理系统 (Azure V7.0)</h1>

<div id="login-panel" class="card max-w-md mx-auto">
  <h2 class="text-lg font-semibold mb-2">登录 Login</h2>
  <label>邮箱 Email</label>
  <input id="login-email" type="email" placeholder="example@domain.com" class="mb-2"/>
  <button id="btn-send-otp" class="btn btn-blue w-full mb-2">发送验证码 / Send OTP</button>
  <label>验证码 OTP</label>
  <input id="login-otp" type="text" placeholder="6位数字" class="mb-2"/>
  <button id="btn-login" class="btn btn-blue w-full">登录 / Login</button>
  <p id="login-status" class="text-center text-sm text-gray-600 mt-2"></p>
</div>

<div id="main-panel" class="hidden">
  <div class="flex justify-between items-center mb-4">
    <div>
      <button id="lang-cn" class="btn btn-blue mr-2">中文</button>
      <button id="lang-en" class="btn btn-blue">English</button>
    </div>
    <div><button id="btn-logout" class="btn btn-blue">登出 / Logout</button></div>
  </div>

  <div id="overview" class="card">
    <h2 class="text-xl font-semibold mb-2">库存总览 / Overview</h2>
    <table class="w-full text-sm" id="tbl-overview">
      <thead><tr><th>型号</th><th>库位</th><th>数量</th><th>单位</th><th>更新时间</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="logs" class="card">
    <h2 class="text-xl font-semibold mb-2">操作日志 / Logs</h2>
    <input id="log-search" placeholder="输入型号 / 搜索" class="mb-2"/>
    <button id="btn-export" class="btn btn-blue mb-2">导出当前结果 / Export CSV</button>
    <table class="w-full text-sm" id="tbl-logs">
      <thead><tr><th>类型</th><th>时间</th><th>型号</th><th>数量</th><th>库位</th><th>操作人</th><th>备注</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API_BASE = "https://meston-inventory-api.azurewebsites.net/api";
let LANG = 'zh', AUTH_EMAIL=null;

const sendOtpBtn=document.getElementById('btn-send-otp');
const loginBtn=document.getElementById('btn-login');
const emailEl=document.getElementById('login-email');
const otpEl=document.getElementById('login-otp');
const statusEl=document.getElementById('login-status');

sendOtpBtn.onclick=async()=>{
  const email=emailEl.value.trim();
  if(!email){statusEl.textContent='请输入邮箱';return;}
  sendOtpBtn.disabled=true;statusEl.textContent='发送中...';
  try{
    const res=await fetch(API_BASE+'/send_otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
    const j=await res.json();
    if(j.success)statusEl.textContent='验证码已发送，请查收邮箱';
    else statusEl.textContent='发送失败：'+(j.error||res.status);
  }catch(e){statusEl.textContent='发送失败：'+e.message;}
  sendOtpBtn.disabled=false;
};

loginBtn.onclick=async()=>{
  const email=emailEl.value.trim(),otp=otpEl.value.trim();
  if(!email||!otp){statusEl.textContent='请输入邮箱和验证码';return;}
  statusEl.textContent='验证中...';
  try{
    const res=await fetch(API_BASE+'/dict_check?email='+encodeURIComponent(email));
    const j=await res.json();
    if(j.authorized){
      localStorage.setItem('auth_email',email);
      AUTH_EMAIL=email;
      document.getElementById('login-panel').classList.add('hidden');
      document.getElementById('main-panel').classList.remove('hidden');
      loadOverview();loadLogs();
    }else statusEl.textContent='未授权邮箱 / Not authorized';
  }catch(e){statusEl.textContent='登录失败：'+e.message;}
};

document.getElementById('btn-logout').onclick=()=>{
  localStorage.removeItem('auth_email');AUTH_EMAIL=null;
  document.getElementById('main-panel').classList.add('hidden');
  document.getElementById('login-panel').classList.remove('hidden');
};

window.addEventListener('load',()=>{
  const saved=localStorage.getItem('auth_email');
  if(saved){AUTH_EMAIL=saved;document.getElementById('login-panel').classList.add('hidden');document.getElementById('main-panel').classList.remove('hidden');loadOverview();loadLogs();}
});

document.getElementById('lang-cn').onclick=()=>{LANG='zh';alert('已切换中文');};
document.getElementById('lang-en').onclick=()=>{LANG='en';alert('Switched to English');};

async function loadOverview(){
  const tbody=document.querySelector('#tbl-overview tbody');tbody.innerHTML='加载中...';
  try{
    const res=await fetch(API_BASE+'/overview');const j=await res.json();
    tbody.innerHTML='';(j.rows||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.model||''}</td><td>${r.storage||''}</td><td>${r.total||0}</td><td>${r.unit||''}</td><td>${r.last_updated||''}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){tbody.innerHTML='<tr><td colspan=5>加载失败 '+e.message+'</td></tr>';}
}

async function loadLogs(){
  const tbody=document.querySelector('#tbl-logs tbody');tbody.innerHTML='加载中...';
  try{
    const res=await fetch(API_BASE+'/logs');const j=await res.json();
    window._logsCache=j.rows||[];renderLogs(_logsCache);
  }catch(e){tbody.innerHTML='<tr><td colspan=7>加载失败 '+e.message+'</td></tr>';}
}

function renderLogs(list){
  const q=document.getElementById('log-search').value.trim().toLowerCase();
  const tbody=document.querySelector('#tbl-logs tbody');tbody.innerHTML='';
  list.filter(r=>!q||String(r.model||'').toLowerCase().includes(q)).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.type||''}</td><td>${r.created_at||''}</td><td>${r.model||''}</td><td>${r.quantity||0}</td><td>${r.storage||r.from_storage||r.to_storage||''}</td><td>${r.operator||''}</td><td>${r.comments||''}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('log-search').oninput=()=>renderLogs(window._logsCache||[]);

document.getElementById('btn-export').onclick=()=>{
  const list=window._logsCache||[];
  const q=document.getElementById('log-search').value.trim().toLowerCase();
  const filtered=list.filter(r=>!q||String(r.model||'').toLowerCase().includes(q));
  const csv=Papa.unparse(filtered);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='logs.csv';a.click();URL.revokeObjectURL(url);
};
</script>
</body>
</html>
